<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracker de Estudos + Pomodoro</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<script>
  // --- CONFIGURAÇÃO FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyCWNFjeLIjBgDa5v3W5vsCdJ1PGDeHE35A",
    authDomain: "meu-study-tracker.firebaseapp.com",
    databaseURL: "https://meu-study-tracker-default-rtdb.firebaseio.com",
    projectId: "meu-study-tracker",
    storageBucket: "meu-study-tracker.firebasestorage.app",
    messagingSenderId: "715609213126",
    appId: "1:715609213126:web:3e9cbe7e840ea20a1b6fc7"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();

  // --- DADOS E BUSCA ---
  const dadosTemas = {
    "Cirurgia Geral": ["Anestesia", "Apendicite aguda", "Choque", "Cicatrização", "Cirurgia vascular", "Cistite aguda", "Hérnias", "Pancreatite aguda", "Queimaduras", "Trauma abdominal", "Trauma torácico"],
    "Clínica Médica": ["Asma", "COVID-19", "Cefaleias", "Dengue", "Diabetes", "HAS", "HIV", "IAM", "ICC", "Pneumonia", "Sepse", "Tuberculose"],
    "Ginecologia e Obstetrícia": ["Abortamento", "Pré-natal", "Câncer de colo uterino", "Câncer de mama", "Diabetes gestacional", "DHEG", "Parto", "Vulvovaginites"],
    "Pediatria": ["Aleitamento", "Asma", "Bronquiolite", "Cardiopatias", "Desenvolvimento", "Imunização", "Pneumonias", "Puericultura"],
    "Medicina Preventiva": ["Epidemiologia", "SUS", "Ética médica", "Vigilância epidemiológica"]
  };
  const listaCompleta = [];
  for (const [cat, temas] of Object.entries(dadosTemas)) { temas.forEach(t => listaCompleta.push({ nome: t, categoria: cat })); }
  let selectedCategory = "Outros";

  // --- ESTADO ---
  let currentMode = 'free';
  let pomodoroState = 'idle';
  let startTime, timerInterval, totalTime = 0;
  let pomoTimeLeft = 0;
  let sessionsByDate = {};
  let dbRef;

  const timerDisplay = document.getElementById('timer');
  const alarmSound = document.getElementById('alarmSound');
  const container = document.getElementById('timerContainer');
  
  // Busca
  const inputTema = document.getElementById('inputTema');
  const listaSugestoes = document.getElementById('listaSugestoes');
  inputTema.addEventListener('input', function() {
    const txt = this.value.toLowerCase();
    listaSugestoes.innerHTML = ''; 
    if (!txt) { listaSugestoes.style.display = 'none'; return; }
    const res = listaCompleta.filter(i => i.nome.toLowerCase().includes(txt));
    if (res.length > 0) {
      listaSugestoes.style.display = 'block';
      res.slice(0, 10).forEach(item => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.innerHTML = `<span>${item.nome}</span><span class="category-tag">${item.categoria}</span>`;
        div.addEventListener('click', () => {
          inputTema.value = item.nome; 
          selectedCategory = item.categoria;
          listaSugestoes.style.display = 'none'; 
        });
        listaSugestoes.appendChild(div);
      });
    } else { listaSugestoes.style.display = 'none'; }
  });
  document.addEventListener('click', e => { if(e.target!==inputTema) listaSugestoes.style.display='none'; });

  // --- TIMERS ---
  function startFree() {
    startTime = new Date().getTime();
    timerInterval = setInterval(() => {
      const now = new Date().getTime();
      totalTime = now - startTime;
      timerDisplay.textContent = formatTime(totalTime);
    }, 1000);
    document.getElementById('startButton').classList.add('hidden');
    document.getElementById('stopButton').classList.remove('hidden');
  }

  function startPomodoroFocus() {
    const mins = parseInt(document.getElementById('focusTime').value);
    pomoTimeLeft = mins * 60;
    pomodoroState = 'focus';
    updatePomoDisplay();
    document.getElementById('pomoStart').classList.add('hidden');
    document.getElementById('pomoStop').classList.remove('hidden');
    document.getElementById('pomodoroSettings').classList.add('hidden');
    container.classList.remove('break-mode');

    timerInterval = setInterval(() => {
      pomoTimeLeft--;
      updatePomoDisplay();
      if (pomoTimeLeft <= 0) {
        clearInterval(timerInterval);
        alarmSound.play();
        alert("Fim do Foco! Salve ou descanse.");
        totalTime = mins * 60 * 1000; 
        document.getElementById('pomoStop').classList.remove('hidden');
        document.getElementById('pomoBreak').classList.remove('hidden');
      }
    }, 1000);
  }

  function startPomodoroBreak() {
    const mins = parseInt(document.getElementById('breakTime').value);
    pomoTimeLeft = mins * 60;
    pomodoroState = 'break';
    updatePomoDisplay();
    container.classList.add('break-mode');
    document.getElementById('pomoBreak').classList.add('hidden');
    document.getElementById('pomoStop').classList.add('hidden');

    timerInterval = setInterval(() => {
      pomoTimeLeft--;
      updatePomoDisplay();
      if (pomoTimeLeft <= 0) {
        clearInterval(timerInterval);
        alarmSound.play();
        alert("Fim da Pausa!");
        resetPomodoroUI();
      }
    }, 1000);
  }

  function updatePomoDisplay() {
    const m = Math.floor(pomoTimeLeft / 60);
    const s = pomoTimeLeft % 60;
    timerDisplay.textContent = `${pad(m)}:${pad(s)}`;
  }

  function resetPomodoroUI() {
    clearInterval(timerInterval);
    pomodoroState = 'idle';
    container.classList.remove('break-mode');
    timerDisplay.textContent = "00:00";
    document.getElementById('pomoStart').classList.remove('hidden');
    document.getElementById('pomoStop').classList.add('hidden');
    document.getElementById('pomoBreak').classList.add('hidden');
    document.getElementById('pomodoroSettings').classList.remove('hidden');
  }

  window.switchMode = function(mode) {
    clearInterval(timerInterval);
    currentMode = mode;
    document.querySelectorAll('.timer-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    if (mode === 'free') {
      document.getElementById('freeControls').classList.remove('hidden');
      document.getElementById('pomodoroControls').classList.add('hidden');
      document.getElementById('pomodoroSettings').classList.add('hidden');
      timerDisplay.textContent = "00:00:00";
      totalTime = 0;
      document.getElementById('startButton').classList.remove('hidden');
      document.getElementById('stopButton').classList.add('hidden');
    } else {
      document.getElementById('freeControls').classList.add('hidden');
      document.getElementById('pomodoroControls').classList.remove('hidden');
      document.getElementById('pomodoroSettings').classList.remove('hidden');
      timerDisplay.textContent = "00:00";
      resetPomodoroUI();
    }
  };

  function saveSession() {
    clearInterval(timerInterval);
    const sessionTimeStr = currentMode === 'free' ? formatTime(totalTime) : formatPomoTime(totalTime);
    const exInput = document.getElementById('exercisesInput');
    const corInput = document.getElementById('correctExercisesInput');
    const exDone = parseInt(exInput.value) || 0;
    const exCorrect = parseInt(corInput.value) || 0;
    const now = new Date();
    const dateKey = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
    if (!sessionsByDate[dateKey]) sessionsByDate[dateKey] = [];
    const accuracy = exDone > 0 ? (exCorrect/exDone*100).toFixed(2) : '0.00';
    const sessionData = {
      time: sessionTimeStr,
      exercisesDone: exDone,
      exercisesCorrect: exCorrect,
      accuracy: accuracy,
      subject: selectedCategory,
      topic: inputTema.value || "Geral"
    };

    sessionsByDate[dateKey].push(sessionData);

    dbRef.set(sessionsByDate).then(() => {
      console.log("Salvo!");
      inicializarDashboard();
    }).catch(e => {
      if(e.code==='PERMISSION_DENIED') alert("Sua conta precisa ser ativada!");
      else alert("Erro ao salvar.");
      sessionsByDate[dateKey].pop();
    });

    totalTime = 0;
    exInput.value = 0; corInput.value = 0; inputTema.value = ''; selectedCategory = "Outros";
    if (currentMode === 'free') {
      document.getElementById('startButton').classList.remove('hidden');
      document.getElementById('stopButton').classList.add('hidden');
      timerDisplay.textContent = "00:00:00";
    } else { resetPomodoroUI(); }
  }

  function pad(n) { return n.toString().padStart(2, '0'); }
  function formatTime(ms) {
    if (!ms) return "00:00:00";
    const h = Math.floor(ms/3600000);
    const m = Math.floor((ms%3600000)/60000);
    const s = Math.floor((ms%60000)/1000);
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  function formatPomoTime(ms) { return formatTime(ms); }

  // --- FUNÇÕES DE CÁLCULO E DASHBOARD (Aqui estava o erro) ---

  function getStartOfWeek(date) {
    const d = new Date(date); const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    d.setHours(0, 0, 0, 0); return new Date(d.setDate(diff));
  }

  // 1. Função que CALCULA (Retorna string "05:30:00")
  function calculateWeeklyStudyTime() {
    const now = new Date(); const start = getStartOfWeek(now);
    let ms = 0;
    for (const k in sessionsByDate) {
      const [y,m,d] = k.split('-').map(Number);
      if (new Date(y, m-1, d) >= start) {
        sessionsByDate[k].forEach(s => {
          const p = s.time.split(':').map(Number);
          if(p.length===3) ms += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
        });
      }
    }
    return formatTime(ms);
  }

  // 2. Função que ATUALIZA O HTML (Essa estava faltando ou fora de ordem!)
  function updateWeeklyStudyTime() {
    const weeklyTime = calculateWeeklyStudyTime();
    document.getElementById('weeklyStudyTime').textContent = weeklyTime;
  }

  function calculateTodayStats() {
    const now = new Date();
    const key = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
    let ms = 0, ex = 0;
    if(sessionsByDate[key]) {
      sessionsByDate[key].forEach(s => {
        const p = s.time.split(':').map(Number);
        if(p.length===3) ms += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
        ex += (s.exercisesDone || 0);
      });
    }
    return { time: formatTime(ms), exercises: ex };
  }

  function updateTodayStats() {
    const stats = calculateTodayStats();
    document.getElementById('todayStudyTime').textContent = stats.time;
    document.getElementById('todayExercises').textContent = stats.exercises;
  }

  function updateTotalStudyTime() {
    let ms = 0;
    for(const k in sessionsByDate) {
      sessionsByDate[k].forEach(s => {
        const p = s.time.split(':').map(Number);
        if(p.length===3) ms += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
      });
    }
    document.getElementById('totalStudyTime').textContent = formatTime(ms);
  }

  // --- Funções Auxiliares para a Lista ---
  function calculateDailyStudyTime(key) {
    let ms = 0;
    if(sessionsByDate[key]) {
      sessionsByDate[key].forEach(s => {
        const p = s.time.split(':').map(Number);
        if(p.length===3) ms += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
      });
    }
    return formatTime(ms);
  }

  function calculateDailyExercises(key) {
    let ex = 0, cor = 0;
    if(sessionsByDate[key]) {
      sessionsByDate[key].forEach(s => { ex += (s.exercisesDone||0); cor += (s.exercisesCorrect||0); });
    }
    return { totalExercises: ex, totalCorrect: cor, accuracy: ex>0 ? (cor/ex*100).toFixed(2) : '0.00' };
  }

  function getAccuracyClass(acc) { return acc>=80?'accuracy-high':acc>=50?'accuracy-medium':'accuracy-low'; }
  function formatDateDisplay(str) { const [y,m,d]=str.split('-'); const mo=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro']; return `${d} de ${mo[parseInt(m)-1]} de ${y}`; }

  function updateSessionList() {
    const list = document.getElementById('sessionList');
    list.innerHTML = '';
    const dates = Object.keys(sessionsByDate).sort((a,b) => {
      const da = new Date(a.split('-').join('/')); const db = new Date(b.split('-').join('/'));
      return db - da;
    });

    for(const date of dates) {
      const dailyTime = calculateDailyStudyTime(date);
      const dailyEx = calculateDailyExercises(date);
      const accClass = getAccuracyClass(parseFloat(dailyEx.accuracy));
      
      const header = document.createElement('h3');
      header.className = 'session-date';
      header.textContent = formatDateDisplay(date);
      list.appendChild(header);

      const summary = document.createElement('div');
      summary.className = 'daily-summary';
      summary.innerHTML = `
        <h4><i class="fas fa-calendar-day"></i> Resumo do Dia</h4>
        <div class="daily-summary-stats">
          <div class="daily-summary-stat"><div class="value">${dailyTime}</div><div class="label">Tempo</div></div>
          <div class="daily-summary-stat"><div class="value">${dailyEx.totalExercises}</div><div class="label">Exercícios</div></div>
          <div class="daily-summary-stat"><div class="value">${dailyEx.totalCorrect}</div><div class="label">Acertos</div></div>
          <div class="daily-summary-stat ${accClass}"><div class="value">${dailyEx.accuracy}%</div><div class="label">Precisão</div></div>
        </div>`;
      list.appendChild(summary);

      sessionsByDate[date].forEach((s, i) => {
        const item = document.createElement('div');
        item.className = 'session-item';
        const sAccClass = getAccuracyClass(parseFloat(s.accuracy));
        const top = (s.topic && s.topic !== "Geral") ? ` - ${s.topic}` : '';
        const sub = s.subject ? `(${s.subject})` : '';
        
        item.innerHTML = `
          <div class="session-stat"><strong>Sessão ${i+1}${sub}${top}:</strong></div>
          <div class="session-stat"><i class="fas fa-clock"></i> ${s.time}</div>
          <div class="session-stat"><i class="fas fa-tasks"></i> ${s.exercisesDone||0}</div>
          <div class="session-stat"><i class="fas fa-check-circle"></i> ${s.exercisesCorrect||0}</div>
          <div class="session-stat ${sAccClass}"><i class="fas fa-bullseye"></i> ${s.accuracy||0}%</div>`;
        list.appendChild(item);
      });
    }
  }

  function updateStatisticsDisplay() {
    let ex=0, cor=0;
    for(const d in sessionsByDate) {
      sessionsByDate[d].forEach(s => { ex+=(s.exercisesDone||0); cor+=(s.exercisesCorrect||0); });
    }
    const acc = ex>0 ? (cor/ex*100).toFixed(2) : '0.00';
    document.getElementById('totalExercisesDone').textContent = ex;
    document.getElementById('totalExercisesCorrect').textContent = cor;
    document.getElementById('averageAccuracy').textContent = acc + '%';
  }

  function updateWeeklyProgress() {
    const wTime = calculateWeeklyStudyTime();
    const p = wTime.split(':').map(Number);
    const hrs = p[0] + p[1]/60;
    const prog = Math.min((hrs/20)*100, 100);
    document.getElementById('weeklyProgress').style.width = `${prog}%`;
  }

  // === FUNÇÃO PRINCIPAL QUE CHAMA TUDO ===
  function inicializarDashboard() {
    console.log("Atualizando dashboard...");
    updateTotalStudyTime();
    updateTodayStats();
    updateWeeklyStudyTime(); // Esta função agora existe e será chamada corretamente
    updateWeeklyProgress();
    updateStatisticsDisplay();
    updateSessionList();
    
    if (Object.keys(sessionsByDate).length > 0) {
      document.getElementById('downloadButton').classList.remove('hidden');
    }
  }

  // --- AUTH & LOAD ---
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      dbRef = database.ref('users/' + user.uid + '/sessionsByDate');
      
      document.getElementById('startButton').addEventListener('click', startFree);
      document.getElementById('stopButton').addEventListener('click', saveSession);
      document.getElementById('pomoStart').addEventListener('click', startPomodoroFocus);
      document.getElementById('pomoBreak').addEventListener('click', startPomodoroBreak);
      document.getElementById('pomoStop').addEventListener('click', saveSession);
      document.getElementById('pomoReset').addEventListener('click', resetPomodoroUI);
      document.getElementById('btnLogout').addEventListener('click', (e)=>{e.preventDefault(); auth.signOut().then(()=>window.location.href='login.html');});

      // Download/Import
      const fileIn = document.createElement('input'); fileIn.type='file'; fileIn.accept='.json,.txt'; fileIn.style.display='none';
      fileIn.addEventListener('change', (e) => {
         const f=e.target.files[0]; if(!f)return;
         const r=new FileReader();
         r.onload = (evt) => {
           try {
             const d = JSON.parse(evt.target.result);
             if(confirm("Mesclar dados? Cancelar substitui.")) {
               const m = {...sessionsByDate, ...d};
               dbRef.set(m).then(()=>location.reload());
             } else {
               dbRef.set(d).then(()=>location.reload());
             }
           } catch(err){alert("Erro no arquivo");}
         };
         r.readAsText(f);
       });
      document.body.appendChild(fileIn);
      document.getElementById('importButton').addEventListener('click', ()=>fileIn.click());
      document.getElementById('downloadButton').addEventListener('click', () => {
         const b = new Blob([JSON.stringify(sessionsByDate,null,2)],{type:'application/json'});
         const u = URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='dados.json';
         document.body.appendChild(a); a.click(); document.body.removeChild(a);
      });

      // Load Data
      try {
        const snap = await dbRef.get();
        if (snap.exists()) sessionsByDate = snap.val();
        inicializarDashboard();
      } catch (e) { console.error(e); }
    } else {
      window.location.href = 'login.html';
    }
  });
</script>
</body>
</html>

