<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracker de Estudos</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  
  <style>
    /* --- CSS GERAL --- */
    :root { --primary-color: #4a6fa5; --secondary-color: #166088; --accent-color: #4fc3f7; --success-color: #4caf50; --warning-color: #ff9800; --danger-color: #f44336; --light-color: #f8f9fa; --dark-color: #343a40; --text-color: #333; --border-radius: 12px; --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; color: var(--text-color); background-color: #f5f7fa; display: flex; min-height: 100vh; overflow-x: hidden; }
    
    /* --- SIDEBAR --- */
    #sidebar { width: 250px; background: linear-gradient(135deg, #2c3e50, #4a6fa5); color: white; padding: 30px 20px; position: fixed; height: 100%; z-index: 1000; top: 0; left: 0; transition: transform 0.3s ease; }
    #sidebar .logo { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    #sidebar .logo h2 { color: white; font-weight: 500; }
    #sidebar .logo i { font-size: 2rem; margin-bottom: 10px; color: var(--accent-color); }
    .sidebar-menu { list-style: none; padding: 0; }
    .sidebar-button { display: flex; align-items: center; padding: 12px 15px; border-radius: 12px; color: white; text-decoration: none; transition: all 0.3s ease; font-size: 0.95rem; margin-bottom: 8px; }
    .sidebar-button:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateX(5px); }
    .sidebar-button i { margin-right: 10px; font-size: 1.1rem; width: 20px; text-align: center; }
    .sidebar-button.active { background-color: var(--accent-color); color: var(--dark-color); font-weight: 500; }
    
    /* Botão Mobile */
    .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
    #sidebar-overlay.show { display: block; }

    /* --- MAIN CONTENT --- */
    #main-content { flex: 1; margin-left: 250px; padding: 30px; max-width: 1000px; width: calc(100% - 250px); margin-right: auto; transition: margin-left 0.3s ease, width 0.3s ease; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header h1 { color: var(--primary-color); font-weight: 500; font-size: 1.8rem; }
    
    /* Stats */
    .today-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .today-stat-card { background-color: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow); text-align: center; }
    .today-stat-card h3 { color: var(--secondary-color); font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .today-stat-card p { font-size: 1.8rem; font-weight: 600; color: var(--primary-color); margin: 0; }
    
    /* Timer Area */
    .timer-section { background-color: white; padding: 30px; border-radius: var(--border-radius); margin-bottom: 30px; text-align: center; box-shadow: var(--box-shadow); max-width: 600px; margin-left: auto; margin-right: auto; }
    #timer { font-size: 4.5rem; font-weight: bold; color: var(--secondary-color); margin: 20px 0; font-family: 'Courier New', monospace; letter-spacing: 2px; }
    
    /* Botões */
    .button-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
    .button { padding: 12px 24px; font-size: 1rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; }
    .button-primary { background-color: var(--primary-color); color: white; }
    .button-primary:hover { background-color: var(--secondary-color); transform: translateY(-2px); }
    .button-danger { background-color: var(--danger-color); color: white; }
    .button-danger:hover { background-color: #d32f2f; transform: translateY(-2px); }
    
    /* Inputs */
    .search-section-wrapper { margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .search-container { position: relative; width: 100%; margin: 0 auto; }
    #inputTema { width: 100%; padding: 12px 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 12px; outline: none; transition: border-color 0.3s; background: white; }
    #inputTema:focus { border-color: var(--primary-color); }
    .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
    .suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
    .suggestion-item:hover { background-color: #f9f9f9; }
    .category-tag { font-size: 11px; color: #555; background: #e0e0e0; padding: 3px 8px; border-radius: 10px; margin-left: 10px; }

    .exercises-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .input-group { display: flex; flex-direction: column; }
    label { margin-bottom: 8px; font-weight: 500; color: var(--secondary-color); }
    input[type="number"] { padding: 12px; border: 1px solid #ddd; border-radius: var(--border-radius); font-size: 1rem; transition: border 0.3s ease; width: 100%; background: white; }
    
    /* Lista */
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background-color: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow); text-align: center; }
    .stat-card h3 { color: var(--secondary-color); font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .stat-card p { font-size: 1.8rem; font-weight: 600; color: var(--primary-color); margin: 0; }
    .progress-container { height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-top: 15px; overflow: hidden; }
    .progress-bar { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--accent-color), var(--primary-color)); width: 0%; transition: width 0.5s ease; }
    
    #sessionList { margin-top: 30px; }
    .session-date { font-weight: 500; color: var(--primary-color); margin-top: 30px; padding-bottom: 8px; border-bottom: 2px solid var(--accent-color); font-size: 1.2rem; }
    .session-item { background-color: white; padding: 20px; border-radius: var(--border-radius); margin: 15px 0; box-shadow: var(--box-shadow); display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; transition: transform 0.3s ease; }
    .session-stat { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
    .accuracy-high { color: var(--success-color); }
    .accuracy-medium { color: var(--warning-color); }
    .accuracy-low { color: var(--danger-color); }
    .daily-summary { background-color: #e8f4fc; padding: 20px; border-radius: var(--border-radius); margin: 20px 0; box-shadow: var(--box-shadow); }
    .daily-summary h4 { color: var(--primary-color); margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .daily-summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
    .daily-summary-stat { display: flex; flex-direction: column; align-items: center; text-align: center; }
    .daily-summary-stat .value { font-size: 1.4rem; font-weight: 600; color: var(--secondary-color); }
    .daily-summary-stat .label { font-size: 0.85rem; color: #666; margin-top: 5px; }

    .hidden { display: none !important; }

    /* --- MEDIA QUERIES (MOBILE) --- */
    @media (max-width: 900px) {
      /* Sidebar Escondida */
      #sidebar { transform: translateX(-100%); width: 260px; }
      #sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
      .mobile-menu-btn { display: block; }
      
      /* Ajustes de Layout */
      #main-content { margin-left: 0; width: 100%; padding: 15px; padding-top: 70px; }
      .today-stats { grid-template-columns: 1fr; gap: 10px; }
      .exercises-section { grid-template-columns: 1fr; }
      .stats-container { grid-template-columns: 1fr 1fr; gap: 10px; }
      .daily-summary-stats { grid-template-columns: 1fr 1fr; }
      
      /* Botões */
      .button-container { flex-direction: column; width: 100%; }
      .button { width: 100%; }
      
      /* Timer */
      .timer-section { padding: 20px; }
      #timer { font-size: 3.5rem; }
    }
  </style>
</head>

<body>
  <button class="mobile-menu-btn" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div id="sidebar">
    <div class="logo"><i class="fas fa-book-open"></i><h2>Med Fácil</h2></div>
    <ul class="sidebar-menu">
      <li><a href="#" class="sidebar-button active"><i class="fas fa-home"></i><span>Início</span></a></li>
      <li><a href="historico.html" class="sidebar-button"><i class="fas fa-history"></i><span>Histórico</span></a></li>
      <li><a href="conteudos.html" class="sidebar-button"><i class="fas fa-book"></i><span>Conteúdos</span></a></li>
      <li><a href="revisoes.html" class="sidebar-button"><i class="fas fa-sync-alt"></i><span>Revisões</span></a></li>
      <li><a id="downloadButton" href="#" class="sidebar-button hidden"><i class="fas fa-download"></i><span>Exportar Dados</span></a></li>
      <li><a id="importButton" href="#" class="sidebar-button"><i class="fas fa-upload"></i><span>Importar Dados</span></a></li>
      <li><a id="btnLogout" href="#" class="sidebar-button"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></li>
    </ul>
  </div>

  <div id="main-content">
    <div class="header"><h1>Tracker de Estudos</h1></div>
    
    <div class="today-stats">
      <div class="today-stat-card"><h3><i class="fas fa-clock"></i> Hoje estudado</h3><p id="todayStudyTime">00:00:00</p></div>
      <div class="today-stat-card"><h3><i class="fas fa-tasks"></i> Exercícios hoje</h3><p id="todayExercises">0</p></div>
    </div>

    <div class="timer-section" id="timerContainer">
      <div id="timer">00:00:00</div>
      <div class="button-container">
        <button id="startButton" class="button button-primary"><i class="fas fa-play"></i> Iniciar Estudo</button>
        <button id="stopButton" class="button button-danger hidden"><i class="fas fa-stop"></i> Parar e Salvar</button>
      </div>
    </div>

    <div class="search-section-wrapper">
      <div class="search-container">
        <label for="inputTema" style="display:block; margin-bottom:8px; font-weight:500; color:#166088;"><i class="fas fa-search"></i> O que vamos estudar?</label>
        <input type="text" id="inputTema" placeholder="Digite o tema (ex: Asma...)" autocomplete="off">
        <div id="listaSugestoes" class="suggestions-list"></div>
      </div>
    </div>

    <div class="exercises-section">
      <div class="input-group"><label for="exercisesInput"><i class="fas fa-tasks"></i> Exercícios Feitos:</label><input type="number" id="exercisesInput" value="0" min="0"></div>
      <div class="input-group"><label for="correctExercisesInput"><i class="fas fa-check-circle"></i> Exercícios Corretos:</label><input type="number" id="correctExercisesInput" value="0" min="0"></div>
    </div>

    <div class="stats-container">
      <div class="stat-card"><h3><i class="fas fa-clock"></i> Tempo Total</h3><p id="totalStudyTime">00:00:00</p></div>
      <div class="stat-card"><h3><i class="fas fa-calendar-week"></i> Esta Semana</h3><p id="weeklyStudyTime">00:00:00</p></div>
      <div class="stat-card"><h3><i class="fas fa-tasks"></i> Exercícios Feitos</h3><p id="totalExercisesDone">0</p></div>
      <div class="stat-card"><h3><i class="fas fa-check-circle"></i> Exercícios Corretos</h3><p id="totalExercisesCorrect">0</p></div>
      <div class="stat-card"><h3><i class="fas fa-bullseye"></i> Precisão Média</h3><p id="averageAccuracy">0%</p></div>
      
      <div class="stat-card">
        <h3><i class="fas fa-bullseye"></i> Meta Semanal</h3>
        <p>20 horas</p>
        <div class="progress-container">
            <div class="progress-bar" id="weeklyProgress"></div>
        </div>
      </div>
    </div>

    <div id="sessionList"></div>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebar-overlay').classList.toggle('show');
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCWNFjeLIjBgDa5v3W5vsCdJ1PGDeHE35A",
      authDomain: "meu-study-tracker.firebaseapp.com",
      databaseURL: "https://meu-study-tracker-default-rtdb.firebaseio.com",
      projectId: "meu-study-tracker",
      storageBucket: "meu-study-tracker.firebasestorage.app",
      messagingSenderId: "715609213126",
      appId: "1:715609213126:web:3e9cbe7e840ea20a1b6fc7"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    const dadosTemas = {
      "Cirurgia Geral": ["Anestesia", "Apendicite aguda", "Choque", "Cicatrização", "Cirurgia vascular", "Cistite aguda", "Hérnias", "Pancreatite aguda", "Queimaduras", "Trauma abdominal", "Trauma torácico"],
      "Clínica Médica": ["Asma", "COVID-19", "Cefaleias", "Dengue", "Diabetes", "HAS", "HIV", "IAM", "ICC", "Pneumonia", "Sepse", "Tuberculose", "Eletrocardiograma"],
      "Ginecologia e Obstetrícia": ["Abortamento", "Pré-natal", "Câncer de colo uterino", "Câncer de mama", "Diabetes gestacional", "DHEG", "Parto", "Vulvovaginites"],
      "Pediatria": ["Aleitamento", "Asma", "Bronquiolite", "Cardiopatias", "Desenvolvimento", "Imunização", "Pneumonias", "Puericultura"],
      "Medicina Preventiva": ["Epidemiologia", "SUS", "Ética médica", "Vigilância epidemiológica"]
    };
    const listaCompleta = [];
    for (const [cat, temas] of Object.entries(dadosTemas)) { temas.forEach(t => listaCompleta.push({ nome: t, categoria: cat })); }
    let selectedCategory = "Outros";

    let startTime, timerInterval, totalTime = 0;
    let sessionsByDate = {};
    let dbRef;

    const timerDisplay = document.getElementById('timer');
    const inputTema = document.getElementById('inputTema');
    const listaSugestoes = document.getElementById('listaSugestoes');

    inputTema.addEventListener('input', function() {
      const txt = this.value.toLowerCase();
      listaSugestoes.innerHTML = ''; 
      if (!txt) { listaSugestoes.style.display = 'none'; return; }
      const res = listaCompleta.filter(i => i.nome.toLowerCase().includes(txt));
      if (res.length > 0) {
        listaSugestoes.style.display = 'block';
        res.slice(0, 10).forEach(item => {
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.innerHTML = `<span>${item.nome}</span><span class="category-tag">${item.categoria}</span>`;
          div.addEventListener('click', () => {
            inputTema.value = item.nome; 
            selectedCategory = item.categoria;
            listaSugestoes.style.display = 'none'; 
          });
          listaSugestoes.appendChild(div);
        });
      } else { listaSugestoes.style.display = 'none'; }
    });
    document.addEventListener('click', e => { if(e.target!==inputTema) listaSugestoes.style.display='none'; });

    function startFree() {
      startTime = new Date().getTime();
      timerInterval = setInterval(() => {
        const now = new Date().getTime();
        totalTime = now - startTime;
        timerDisplay.textContent = formatTime(totalTime);
      }, 1000);
      document.getElementById('startButton').classList.add('hidden');
      document.getElementById('stopButton').classList.remove('hidden');
    }

    // --- SALVAR SESSÃO COM INTELIGÊNCIA DE AGENDA ---
    async function saveSession() {
      clearInterval(timerInterval);
      
      const sessionTimeStr = formatTime(totalTime);
      const exDone = parseInt(document.getElementById('exercisesInput').value) || 0;
      const exCorrect = parseInt(document.getElementById('correctExercisesInput').value) || 0;
      
      const now = new Date();
      const dateKey = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
      
      if (!sessionsByDate[dateKey]) sessionsByDate[dateKey] = [];
      
      const accuracy = exDone > 0 ? (exCorrect/exDone*100).toFixed(2) : '0.00';
      const topic = inputTema.value || "Geral";
      const subject = selectedCategory;

      const sessionData = {
        time: sessionTimeStr,
        exercisesDone: exDone,
        exercisesCorrect: exCorrect,
        accuracy: accuracy,
        subject: subject,
        topic: topic
      };

      sessionsByDate[dateKey].push(sessionData);
      
      try {
        // 1. Salva Sessão
        await dbRef.set(sessionsByDate);
        console.log("Sessão salva!");
        
        // 2. Agenda Revisão Inteligente
        if (topic !== "Geral") {
          await updateReviewSchedule(subject, topic, auth.currentUser.uid);
        }

        inicializarDashboard();
      } catch (e) {
        console.error(e);
        if(e.code==='PERMISSION_DENIED') alert("Sua conta precisa ser ativada!");
        else alert("Erro ao salvar.");
        sessionsByDate[dateKey].pop();
      }

      totalTime = 0;
      document.getElementById('exercisesInput').value = 0; 
      document.getElementById('correctExercisesInput').value = 0; 
      inputTema.value = ''; 
      selectedCategory = "Outros";
      document.getElementById('startButton').classList.remove('hidden');
      document.getElementById('stopButton').classList.add('hidden');
      timerDisplay.textContent = "00:00:00";
    }

    // --- NOVA LÓGICA DE AGENDAMENTO (COM DIAS PERMITIDOS) ---
    async function updateReviewSchedule(subject, topic, uid) {
      const safeTopicKey = topic.replace(/[.#$/\[\]]/g, '_');
      const reviewRef = database.ref(`users/${uid}/reviews/${safeTopicKey}`);
      const settingsRef = database.ref(`users/${uid}/settings/studyDays`);

      // 1. Busca dados atuais E configurações de dias
      const [snapReview, snapSettings] = await Promise.all([
          reviewRef.get(),
          settingsRef.get()
      ]);

      // 2. Define Nível
      let level = 0;
      if (snapReview.exists()) {
        level = (snapReview.val().level || 0) + 1;
      }

      // 3. Define Dias Permitidos (0=Dom, 1=Seg... padrão: todos)
      const allowedDays = snapSettings.exists() ? snapSettings.val() : [0, 1, 2, 3, 4, 5, 6];

      // 4. Calcula Data Base
      const intervals = [1, 7, 30, 120];
      const daysToAdd = intervals[Math.min(level, intervals.length - 1)];
      let targetDate = new Date();
      targetDate.setDate(targetDate.getDate() + daysToAdd);

      // 5. AJUSTE DE DIAS PROIBIDOS
      if (allowedDays && allowedDays.length > 0) {
          // Loop de segurança (max 30 dias para evitar travamento)
          let safety = 0;
          while (!allowedDays.includes(targetDate.getDay()) && safety < 30) {
              console.log(`Dia ${targetDate.getDay()} bloqueado. Avançando...`);
              targetDate.setDate(targetDate.getDate() + 1);
              safety++;
          }
      }

      // 6. Salva
      await reviewRef.set({
        subject: subject,
        topic: topic,
        lastStudied: new Date().toISOString(),
        nextReview: targetDate.toISOString(),
        level: level
      });
      
      console.log(`Agendado para ${targetDate.toLocaleDateString()} (Nível ${level})`);
    }

    // --- HELPERS ---
    function pad(n) { return n.toString().padStart(2, '0'); }
    function formatTime(ms) {
      if (!ms) return "00:00:00";
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      const s = Math.floor((ms%60000)/1000);
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    // --- CÁLCULOS DE DASHBOARD ---
    function getStartOfWeek(date) {
      const d = new Date(date); const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setHours(0, 0, 0, 0); return new Date(d.setDate(diff));
    }

    function calculateWeeklyStudyTime() {
      const now = new Date(); const start = getStartOfWeek(now);
      let ms = 0;
      for (const k in sessionsByDate) {
        const [y,m,d] = k.split('-').map(Number);
        if (new Date(y, m-1, d) >= start) {
          sessionsByDate[k].forEach(s => {
            const p = s.time.split(':').map(Number);
            if(p.length===3) ms += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
          });
        }
      }
      return formatTime(ms);
    }

    function updateWeeklyStudyTime() {
      document.getElementById('weeklyStudyTime').textContent = calculateWeeklyStudyTime();
    }
    
    function updateWeeklyProgress() {
      const wTime = calculateWeeklyStudyTime();
      const p = wTime.split(':').map(Number);
      const hrs = p[0] + p[1]/60;
      const prog = Math.min((hrs/20)*100, 100);
      document.getElementById('weeklyProgress').style.width = `${prog}%`;
    }

    function calculateTodayStats() {
      const now = new Date();
      const key = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
      let ms = 0, ex = 0;
      if(sessionsByDate[key]) {
        sessionsByDate[key].forEach(s => {
          const p = s.time.split(':').map(Number);
          if(p.length===3) ms += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
          ex += (s.exercisesDone || 0);
        });
      }
      return { time: formatTime(ms), exercises: ex };
    }

    function updateTodayStats() {
      const stats = calculateTodayStats();
      document.getElementById('todayStudyTime').textContent = stats.time;
      document.getElementById('todayExercises').textContent = stats.exercises;
    }

    function updateTotalStudyTime() {
      let ms = 0;
      for(const k in sessionsByDate) {
        sessionsByDate[k].forEach(s => {
          const p = s.time.split(':').map(Number);
          if(p.length===3) ms += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
        });
      }
      document.getElementById('totalStudyTime').textContent = formatTime(ms);
    }

    function calculateDailyStudyTime(key) {
      let ms = 0;
      if(sessionsByDate[key]) {
        sessionsByDate[key].forEach(s => {
          const p = s.time.split(':').map(Number);
          if(p.length===3) ms += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
        });
      }
      return formatTime(ms);
    }

    function calculateDailyExercises(key) {
      let ex = 0, cor = 0;
      if(sessionsByDate[key]) {
        sessionsByDate[key].forEach(s => { ex += (s.exercisesDone||0); cor += (s.exercisesCorrect||0); });
      }
      return { totalExercises: ex, totalCorrect: cor, accuracy: ex>0 ? (cor/ex*100).toFixed(2) : '0.00' };
    }

    function getAccuracyClass(acc) { return acc>=80?'accuracy-high':acc>=50?'accuracy-medium':'accuracy-low'; }
    function formatDateDisplay(str) { const [y,m,d]=str.split('-'); const mo=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro']; return `${d} de ${mo[parseInt(m)-1]} de ${y}`; }

    function updateSessionList() {
      const list = document.getElementById('sessionList');
      list.innerHTML = '';
      const dates = Object.keys(sessionsByDate).sort((a,b) => {
        const da = new Date(a.split('-').join('/')); const db = new Date(b.split('-').join('/'));
        return db - da;
      });

      for(const date of dates) {
        const dailyTime = calculateDailyStudyTime(date);
        const dailyEx = calculateDailyExercises(date);
        const accClass = getAccuracyClass(parseFloat(dailyEx.accuracy));
        
        const header = document.createElement('h3');
        header.className = 'session-date';
        header.textContent = formatDateDisplay(date);
        list.appendChild(header);

        const summary = document.createElement('div');
        summary.className = 'daily-summary';
        summary.innerHTML = `
          <h4><i class="fas fa-calendar-day"></i> Resumo do Dia</h4>
          <div class="daily-summary-stats">
            <div class="daily-summary-stat"><div class="value">${dailyTime}</div><div class="label">Tempo</div></div>
            <div class="daily-summary-stat"><div class="value">${dailyEx.totalExercises}</div><div class="label">Questões</div></div>
            <div class="daily-summary-stat"><div class="value">${dailyEx.totalCorrect}</div><div class="label">Acertos</div></div>
            <div class="daily-summary-stat ${accClass}"><div class="value">${dailyEx.accuracy}%</div><div class="label">Precisão</div></div>
          </div>`;
        list.appendChild(summary);

        sessionsByDate[date].forEach((s, i) => {
          const item = document.createElement('div');
          item.className = 'session-item';
          const sAccClass = getAccuracyClass(parseFloat(s.accuracy));
          const top = (s.topic && s.topic !== "Geral") ? ` - ${s.topic}` : '';
          const sub = s.subject ? `(${s.subject})` : '';
          item.innerHTML = `
            <div class="session-stat"><strong>Sessão ${i+1}${sub}${top}:</strong></div>
            <div class="session-stat"><i class="fas fa-clock"></i> ${s.time}</div>
            <div class="session-stat"><i class="fas fa-tasks"></i> ${s.exercisesDone||0}</div>
            <div class="session-stat"><i class="fas fa-check-circle"></i> ${s.exercisesCorrect||0}</div>
            <div class="session-stat ${sAccClass}"><i class="fas fa-bullseye"></i> ${s.accuracy||0}%</div>`;
          list.appendChild(item);
        });
      }
    }

    function updateStatisticsDisplay() {
      let ex=0, cor=0;
      for(const d in sessionsByDate) {
        sessionsByDate[d].forEach(s => { ex+=(s.exercisesDone||0); cor+=(s.exercisesCorrect||0); });
      }
      const acc = ex>0 ? (cor/ex*100).toFixed(2) : '0.00';
      document.getElementById('totalExercisesDone').textContent = ex;
      document.getElementById('totalExercisesCorrect').textContent = cor;
      document.getElementById('averageAccuracy').textContent = acc + '%';
    }

    function inicializarDashboard() {
      console.log("Atualizando dashboard...");
      updateTotalStudyTime();
      updateTodayStats();
      updateWeeklyStudyTime();
      updateWeeklyProgress();
      updateStatisticsDisplay();
      updateSessionList();
      if (Object.keys(sessionsByDate).length > 0) {
        document.getElementById('downloadButton').classList.remove('hidden');
      }
    }

    // --- AUTH & LOAD ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        dbRef = database.ref('users/' + user.uid + '/sessionsByDate');
        
        document.getElementById('startButton').addEventListener('click', startFree);
        document.getElementById('stopButton').addEventListener('click', saveSession);
        document.getElementById('btnLogout').addEventListener('click', (e)=>{e.preventDefault(); auth.signOut().then(()=>window.location.href='login.html');});

        const fileIn = document.createElement('input'); fileIn.type='file'; fileIn.accept='.json,.txt'; fileIn.style.display='none';
        fileIn.addEventListener('change', (e) => {
           const f=e.target.files[0]; if(!f)return;
           const r=new FileReader();
           r.onload = (evt) => {
             try {
               const d = JSON.parse(evt.target.result);
               if(confirm("Mesclar dados? Cancelar substitui.")) {
                 const m = {...sessionsByDate, ...d};
                 dbRef.set(m).then(()=>location.reload());
               } else {
                 dbRef.set(d).then(()=>location.reload());
               }
             } catch(err){alert("Erro no arquivo");}
           };
           r.readAsText(f);
        });
        document.body.appendChild(fileIn);
        document.getElementById('importButton').addEventListener('click', ()=>fileIn.click());
        document.getElementById('downloadButton').addEventListener('click', () => {
           const b = new Blob([JSON.stringify(sessionsByDate,null,2)],{type:'application/json'});
           const u = URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='dados.json';
           document.body.appendChild(a); a.click(); document.body.removeChild(a);
        });

        try {
          const snap = await dbRef.get();
          if (snap.exists()) sessionsByDate = snap.val();
          inicializarDashboard();
        } catch (e) { console.error(e); }
      } else {
        window.location.href = 'login.html';
      }
    });

    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const btn = document.querySelector('.mobile-menu-btn');
      if(window.innerWidth <= 900 && !sidebar.contains(e.target) && !btn.contains(e.target)) {
        sidebar.classList.remove('open');
        document.getElementById('sidebar-overlay').classList.remove('show');
      }
    });
  </script>
</body>
</html>
