<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Desempenho Detalhado</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- CSS BASE --- */
    :root { --primary-color: #4a6fa5; --secondary-color: #166088; --accent-color: #4fc3f7; --text-color: #333; --bg-color: #f5f7fa; --card-bg: #ffffff; --border-radius: 12px; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; min-height: 100vh; overflow-x: hidden; }
    
    /* Sidebar Fixa */
    #sidebar { width: 250px; background: linear-gradient(135deg, #2c3e50, #4a6fa5); color: white; padding: 30px 20px; position: fixed; height: 100%; z-index: 1000; top: 0; left: 0; }
    #sidebar .logo { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
    #sidebar .logo h2 { color: white; font-weight: 500; }
    #sidebar .logo i { font-size: 2rem; margin-bottom: 10px; color: var(--accent-color); }
    .sidebar-menu { list-style: none; }
    .sidebar-button { display: flex; align-items: center; padding: 12px 15px; border-radius: 12px; color: white; text-decoration: none; margin-bottom: 10px; transition: 0.3s; }
    .sidebar-button:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
    .sidebar-button.active { background-color: var(--accent-color); color: #343a40; font-weight: 500; }
    .sidebar-button i { margin-right: 10px; width: 20px; text-align: center; }

    /* Layout Principal */
    #main-content { 
      flex: 1; 
      margin-left: 250px; 
      padding: 40px; 
      width: calc(100% - 250px); 
      max-width: 1400px; 
      margin-right: auto;
    }
    
    /* Cabeçalho e Filtros */
    .dashboard-header { margin-bottom: 30px; }
    .page-title { color: var(--secondary-color); font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Abas de Filtro */
    .tabs-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; }
    .filter-tab {
      padding: 8px 16px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      color: #666;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .filter-tab:hover { transform: translateY(-2px); }
    .filter-tab.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 4px 10px rgba(74, 111, 165, 0.3);
    }

    /* Barra de Pesquisa e Ordenação */
    .controls-row { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .search-wrapper { flex: 2; position: relative; min-width: 200px; }
    .search-input {
      width: 100%;
      padding: 10px 40px 10px 20px;
      border-radius: 25px;
      border: 1px solid #ddd;
      outline: none;
      font-size: 0.95rem;
    }
    .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #888; }
    
    .options-wrapper { display: flex; gap: 15px; align-items: center; flex: 1; justify-content: flex-end; }
    .sort-select {
      padding: 10px 15px;
      border-radius: 25px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 600;
      outline: none;
    }

    /* Toggle Switch */
    .toggle-container { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; color: #555; user-select: none; }
    .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* --- LISTA DE TÓPICOS --- */
    .topics-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 40px; }
    .topics-header { display: flex; justify-content: space-between; color: #888; font-weight: 500; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    
    .topic-row {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f9f9f9;
      transition: background 0.2s;
    }
    .topic-row:hover { background-color: #fcfcfc; }
    
    .topic-name { flex: 3; font-weight: 500; color: #444; padding-right: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .topic-data-area { flex: 4; display: flex; align-items: center; gap: 20px; }
    .progress-track { flex: 1; height: 10px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 10px; transition: width 1s ease; }
    
    .topic-time { width: 80px; text-align: right; color: #666; font-size: 0.9rem; font-weight: 500; }
    .topic-percentage { width: 50px; text-align: right; font-weight: 700; color: #333; }

    /* Cores */
    .bar-blue { background-color: #00acc1; }
    .bar-gray { background-color: #cfd8dc; }

    /* Gráfico */
    .chart-section { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; }
    .chart-wrapper { position: relative; height: 400px; width: 100%; max-width: 600px; margin: 0 auto; }

    @media (max-width: 900px) {
      #main-content { margin-left: 70px; width: calc(100% - 70px); padding: 20px; }
      #sidebar { width: 70px; padding: 20px 10px; }
      #sidebar .logo h2, .sidebar-button span { display: none; }
      #sidebar .logo i, .sidebar-button i { margin: 0; font-size: 1.5rem; }
      .sidebar-button { justify-content: center; }
    }

    @media (max-width: 768px) {
      #main-content { margin-left: 0; width: 100%; padding-top: 90px; }
      #sidebar { width: 100%; height: auto; padding: 10px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; }
      .sidebar-menu { display: none; }
      
      .topic-row { flex-wrap: wrap; gap: 5px; }
      .topic-name { flex: 100%; margin-bottom: 5px; }
      .topic-data-area { width: 100%; }
      
      .controls-row { flex-direction: column; align-items: stretch; }
      .options-wrapper { justify-content: space-between; }
    }
  </style>
</head>
<body>

<div id="sidebar">
  <div class="logo">
    <i class="fas fa-book-open"></i>
    <h2>Med Fácil</h2>
  </div>
  <ul class="sidebar-menu">
    <li><a href="index.html" class="sidebar-button"><i class="fas fa-home"></i><span>Início</span></a></li>
    <li><a href="historico.html" class="sidebar-button"><i class="fas fa-history"></i><span>Histórico</span></a></li>
    <li><a href="#" class="sidebar-button active"><i class="fas fa-book"></i><span>Conteúdos</span></a></li>
    <li><a id="btnLogout" href="#" class="sidebar-button"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></li>
  </ul>
</div>

<div id="main-content">
  
  <div class="dashboard-header">
    <h1 class="page-title">Desempenho por Área</h1>
    
    <div class="tabs-container">
      <div class="filter-tab active" data-filter="all">Geral</div>
      <div class="filter-tab" data-filter="Cirurgia Geral">Cirurgia</div>
      <div class="filter-tab" data-filter="Clínica Médica">Clínica Médica</div>
      <div class="filter-tab" data-filter="Pediatria">Pediatria</div>
      <div class="filter-tab" data-filter="Ginecologia e Obstetrícia">G.O.</div>
      <div class="filter-tab" data-filter="Medicina Preventiva">Preventiva</div>
    </div>

    <div class="controls-row">
      <div class="search-wrapper">
        <input type="text" class="search-input" id="searchInput" placeholder="Pesquisar assunto...">
        <i class="fas fa-search search-icon"></i>
      </div>
      
      <div class="options-wrapper">
        <label class="toggle-container">
          <div class="toggle-switch">
            <input type="checkbox" id="toggleEmpty">
            <span class="slider"></span>
          </div>
          Mostrar não estudados
        </label>

        <select class="sort-select" id="sortSelect">
          <option value="az">A-Z</option>
          <option value="performance_desc">Melhor %</option>
          <option value="performance_asc">Pior %</option>
          <option value="questions">Mais Questões</option>
        </select>
      </div>
    </div>
  </div>

  <div id="loading-message" style="text-align: center; color: #666; margin-top: 50px;">
    <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Carregando seus dados...
  </div>

  <div class="topics-container" id="topicsContainer" style="display: none;">
    <div class="topics-header">
      <span style="flex: 3;">Assunto</span>
      <div style="flex: 4; display: flex; justify-content: flex-end; gap: 35px;">
        <span>Progresso</span>
        <span style="width: 80px; text-align: right;">Tempo</span>
        <span style="width: 50px; text-align: right;">%</span>
      </div>
    </div>
    <div id="topicsList"></div>
  </div>

  <div class="chart-section" id="chartSection" style="display: none;">
    <h3 style="color: var(--secondary-color); margin-bottom: 20px;">Visão Geral</h3>
    <div class="chart-wrapper">
      <canvas id="skillsChart"></canvas>
    </div>
  </div>

</div>

<script>
  // === CONFIGURAÇÃO FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyCWNFjeLIjBgDa5v3W5vsCdJ1PGDeHE35A",
    authDomain: "meu-study-tracker.firebaseapp.com",
    databaseURL: "https://meu-study-tracker-default-rtdb.firebaseio.com",
    projectId: "meu-study-tracker",
    storageBucket: "meu-study-tracker.firebasestorage.app",
    messagingSenderId: "715609213126",
    appId: "1:715609213126:web:3e9cbe7e840ea20a1b6fc7"
  };

  let database, auth;
  try {
    const app = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    auth = firebase.auth(); 
  } catch (error) { console.error(error); }

  // --- DADOS BASE COM PREVENTIVA CORRIGIDA ---
  const dadosTemasBase = {
    "Cirurgia Geral": ["Anestesia", "Apendicite aguda", "Atendimento inicial ao politraumatizado", "Avaliação da função hepática", "Choque", "Cicatrização", "Cirrose hepática", "Cirurgia vascular", "Cistite aguda", "Complicações pós-operatórias", "Cuidados pré-operatórios", "Câncer de cólon e reto", "Câncer de esôfago", "Câncer de próstata", "Diarreias", "Doença diverticular", "DRGE", "Doença ulcerosa péptica", "Doenças inflamatórias intestinais", "Hemorragia digestiva alta", "Hérnias", "Litíase biliar", "Litíase urinária", "Pancreatite aguda", "Queimaduras", "Trauma abdominal", "Trauma torácico"],
    "Clínica Médica": ["Anemias", "Angina estável", "Asma", "COVID-19", "Cefaleias", "Demência", "Dengue", "Diabetes", "DPOC", "Doença renal crônica", "HAS", "HIV", "IAM", "ICC", "Infecção Urinaria", "Pneumonia", "Sepse", "Tuberculose", "AVC"],
    "Ginecologia e Obstetrícia": ["Abortamento", "Amenorreia", "Anticoncepção", "Pré-natal", "Câncer de colo uterino", "Câncer de mama", "Diabetes gestacional", "DHEG", "Endometriose", "Parto", "Sangramento uterino", "SOP", "Vulvovaginites"],
    "Pediatria": ["Aleitamento", "Asma", "Bronquiolite", "Cardiopatias", "Desenvolvimento", "Doenças exantemáticas", "Imunização", "Infecção Urinaria", "Pneumonias", "Puericultura", "Reanimação neonatal"],
    
    // LISTA COMPLETA DE PREVENTIVA ADICIONADA AQUI
    "Medicina Preventiva": [
      "Análise de métodos diagnósticos", "Caso-controle", "Conceitos na atenção primária", "Coorte", 
      "Dinâmica de transmissão e distribuição temporal das doenças", "Ensaio clínico", "Gestão do SUS", 
      "Humanização do atendimento médico", "Leis e diretrizes do SUS", 
      "Medicina baseada em evidências, revisão sistemática e meta-análise", "Medicina do trabalho", 
      "Medicina legal", "Morbidade", "Mortalidade", "Outros", "Outros Indicadores", 
      "Prevenção 1ª/2ª/3ª/4ª", "Princípios do SUS", "Saúde do idoso", "Testes estatísticos", 
      "Transição epidemiológica e demográfica", "Vigilância epidemiológica", "Ética médica"
    ]
  };

  // --- ESTADO GLOBAL ---
  let allSubjectsData = {}; 
  let currentFilter = 'all';
  let currentSort = 'az';
  let showEmpty = false;
  let chartInstance = null;

  // --- FUNÇÕES AUXILIARES ---
  function timeToMinutes(timeStr) {
    if (!timeStr) return 0;
    const p = timeStr.split(':').map(Number);
    if (p.length !== 3) return 0;
    return (p[0] * 60) + p[1] + (p[2]/60);
  }

  function formatMinutesToHrs(totalMinutes) {
    if (totalMinutes === 0) return "0h";
    const h = Math.floor(totalMinutes / 60);
    const m = Math.floor(totalMinutes % 60);
    if (h > 0) return `${h}h ${m}m`;
    return `${m}m`;
  }

  // --- PROCESSAMENTO DE DADOS ---
  function processData(sessionsByDate) {
    const subjects = {};
    
    // 1. Preenche com a base de dados estática
    for (const [area, temas] of Object.entries(dadosTemasBase)) {
      subjects[area] = {
        totalQuestions: 0,
        totalCorrect: 0,
        topics: {}
      };
      temas.forEach(tema => {
        subjects[area].topics[tema] = {
          totalTime: 0,
          questions: 0,
          correct: 0
        };
      });
    }

    // 2. Preenche com dados do Firebase
    if (sessionsByDate) {
      for (const date in sessionsByDate) {
        sessionsByDate[date].forEach(session => {
          const subjectName = session.subject || 'Outros';
          const topicName = (session.topic && session.topic.trim() !== "") ? session.topic : 'Geral';

          if (!subjects[subjectName]) {
            subjects[subjectName] = { totalQuestions: 0, totalCorrect: 0, topics: {} };
          }

          if (!subjects[subjectName].topics[topicName]) {
            subjects[subjectName].topics[topicName] = { totalTime: 0, questions: 0, correct: 0 };
          }

          subjects[subjectName].totalQuestions += (session.exercisesDone || 0);
          subjects[subjectName].totalCorrect += (session.exercisesCorrect || 0);

          const tStat = subjects[subjectName].topics[topicName];
          tStat.totalTime += timeToMinutes(session.time);
          tStat.questions += (session.exercisesDone || 0);
          tStat.correct += (session.exercisesCorrect || 0);
        });
      }
    }

    allSubjectsData = subjects;
    renderInterface();
  }

  function renderInterface() {
    renderTopicList();
    renderChart();
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('topicsContainer').style.display = 'block';
    document.getElementById('chartSection').style.display = 'block';
  }

  function renderTopicList() {
    const listContainer = document.getElementById('topicsList');
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
    listContainer.innerHTML = '';

    let flatList = [];

    for (const [areaName, areaData] of Object.entries(allSubjectsData)) {
      if (currentFilter !== 'all' && areaName !== currentFilter) continue;

      for (const [topicName, stats] of Object.entries(areaData.topics)) {
        if (searchQuery && !topicName.toLowerCase().includes(searchQuery)) continue;
        if (!showEmpty && stats.questions === 0) continue;

        const accuracy = stats.questions > 0 ? (stats.correct / stats.questions * 100) : 0;
        
        flatList.push({
          area: areaName,
          name: topicName,
          accuracy: accuracy,
          questions: stats.questions,
          time: stats.totalTime
        });
      }
    }

    flatList.sort((a, b) => {
      if (currentSort === 'az') return a.name.localeCompare(b.name);
      if (currentSort === 'performance_desc') return b.accuracy - a.accuracy;
      if (currentSort === 'performance_asc') {
        if(a.accuracy === 0 && b.accuracy === 0) return a.name.localeCompare(b.name);
        return a.accuracy - b.accuracy;
      }
      if (currentSort === 'questions') return b.questions - a.questions;
    });

    if (flatList.length === 0) {
      listContainer.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">Nenhum tópico encontrado.</p>';
      return;
    }

    flatList.forEach(item => {
      let barClass = 'bar-blue';
      if (item.questions === 0) barClass = 'bar-gray';
      else if (item.accuracy >= 80) barClass = 'bar-blue'; 
      
      const html = `
        <div class="topic-row">
          <div class="topic-name">
            ${item.name} 
            ${currentFilter === 'all' ? `<span style="font-size:0.75rem; color:#999; margin-left:5px; background:#eee; padding:2px 6px; border-radius:4px;">${item.area}</span>` : ''}
          </div>
          
          <div class="topic-data-area">
            <div class="progress-track">
              <div class="progress-fill ${barClass}" style="width: ${item.questions > 0 ? item.accuracy : 0}%"></div>
            </div>
            
            <div class="topic-time">
              ${item.time > 0 ? '<i class="far fa-clock" style="font-size:0.8rem; margin-right:3px;"></i>' : ''}
              ${formatMinutesToHrs(item.time)}
            </div>
            
            <div class="topic-percentage">${item.questions > 0 ? item.accuracy.toFixed(0) + '%' : '-'}</div>
          </div>
        </div>
      `;
      listContainer.innerHTML += html;
    });
  }

  function renderChart() {
    const ctx = document.getElementById('skillsChart').getContext('2d');
    
    const labels = [];
    const dataPoints = [];
    const mainAreas = ["Clínica Médica", "Cirurgia Geral", "Pediatria", "Ginecologia e Obstetrícia", "Medicina Preventiva"];
    
    mainAreas.forEach(area => {
      labels.push(area);
      if (allSubjectsData[area] && allSubjectsData[area].totalQuestions > 0) {
        const acc = (allSubjectsData[area].totalCorrect / allSubjectsData[area].totalQuestions * 100);
        dataPoints.push(acc.toFixed(1));
      } else {
        dataPoints.push(0);
      }
    });

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Desempenho (%)',
          data: dataPoints,
          backgroundColor: 'rgba(0, 172, 193, 0.2)',
          borderColor: '#00acc1',
          pointBackgroundColor: '#fff',
          pointBorderColor: '#00acc1',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            angleLines: { display: true, color: '#eee' },
            grid: { color: '#f0f0f0' },
            suggestedMin: 0,
            suggestedMax: 100,
            ticks: { stepSize: 20, backdropColor: 'transparent', display: false },
            pointLabels: {
              font: { size: 12, weight: 'bold' },
              color: '#555'
            }
          }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  // --- EVENT LISTENERS ---
  window.addEventListener('load', () => {
    const tabs = document.querySelectorAll('.filter-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.getAttribute('data-filter');
        renderTopicList();
      });
    });

    document.getElementById('searchInput').addEventListener('input', renderTopicList);
    
    document.getElementById('toggleEmpty').addEventListener('change', (e) => {
      showEmpty = e.target.checked;
      renderTopicList();
    });

    document.getElementById('sortSelect').addEventListener('change', (e) => {
      currentSort = e.target.value;
      renderTopicList();
    });

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const btnLogout = document.getElementById('btnLogout');
        if(btnLogout) btnLogout.addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut().then(() => window.location.href = 'login.html');
        });

        try {
          const snapshot = await database.ref('users/' + user.uid + '/sessionsByDate').get();
          const data = snapshot.exists() ? snapshot.val() : null;
          processData(data);
        } catch (error) { console.error(error); }
      } else {
        window.location.href = 'login.html';
      }
    });
  });
</script>
</body>
</html>
