<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracker de Estudos</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  
  <style>
    :root {
      --primary-color: #4a6fa5;
      --secondary-color: #166088;
      --accent-color: #4fc3f7;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --text-color: #333;
      --border-radius: 12px;
      --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --sidebar-width: 250px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; color: var(--text-color); background-color: #f5f7fa; display: flex; min-height: 100vh; }
    #sidebar { width: var(--sidebar-width); background: linear-gradient(135deg, #2c3e50, #4a6fa5); color: white; padding: 30px 20px; position: fixed; height: 100%; box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; z-index: 100; }
    #sidebar .logo { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    #sidebar .logo h2 { color: white; font-weight: 500; }
    #sidebar .logo i { font-size: 2rem; margin-bottom: 10px; color: var(--accent-color); }
    .sidebar-menu { list-style: none; }
    .sidebar-menu li { margin-bottom: 10px; }
    .sidebar-button { display: flex; align-items: center; padding: 12px 15px; border-radius: var(--border-radius); color: white; text-decoration: none; transition: all 0.3s ease; font-size: 0.95rem; }
    .sidebar-button:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateX(5px); }
    .sidebar-button i { margin-right: 10px; font-size: 1.1rem; width: 20px; text-align: center; }
    .sidebar-button.active { background-color: var(--accent-color); color: var(--dark-color); font-weight: 500; }
    #main-content { flex: 1; margin-left: var(--sidebar-width); padding: 30px; max-width: 1000px; margin: 0 auto; padding-left: calc(var(--sidebar-width) + 30px); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header h1 { color: var(--primary-color); font-weight: 500; }
    .today-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .today-stat-card { background-color: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow); text-align: center; transition: transform 0.3s ease; }
    .today-stat-card:hover { transform: translateY(-5px); }
    .today-stat-card h3 { color: var(--secondary-color); font-size: 1rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .today-stat-card p { font-size: 1.8rem; font-weight: 600; color: var(--primary-color); }
    .timer-section { background-color: white; padding: 30px; border-radius: var(--border-radius); margin-bottom: 30px; text-align: center; box-shadow: var(--box-shadow); max-width: 600px; margin-left: auto; margin-right: auto; }
    #timer { font-size: 4rem; font-weight: bold; color: var(--secondary-color); margin: 20px 0; font-family: 'Courier New', monospace; letter-spacing: 2px; }
    .button-container { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
    .button { padding: 12px 24px; font-size: 1rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-weight: 500; }
    .button-primary { background-color: var(--primary-color); color: white; }
    .button-primary:hover { background-color: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
    .button-danger { background-color: var(--danger-color); color: white; }
    .button-danger:hover { background-color: #d32f2f; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
    .button-success { background-color: var(--success-color); color: white; }
    .button-success:hover { background-color: #388e3c; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
    
    /* Estilo para os inputs de categoria */
    .exercises-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .input-group { display: flex; flex-direction: column; }
    label { margin-bottom: 8px; font-weight: 500; color: var(--secondary-color); }
    input[type="number"], input[type="text"], select { padding: 12px; border: 1px solid #ddd; border-radius: var(--border-radius); font-size: 1rem; transition: border 0.3s ease; width: 100%; background: white; }
    input:focus, select:focus { border-color: var(--primary-color); outline: none; }
    
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background-color: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow); text-align: center; transition: transform 0.3s ease; }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-card h3 { color: var(--secondary-color); font-size: 1rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .stat-card p { font-size: 1.8rem; font-weight: 600; color: var(--primary-color); }
    #sessionList { margin-top: 30px; }
    .session-date { font-weight: 500; color: var(--primary-color); margin-top: 30px; padding-bottom: 8px; border-bottom: 2px solid var(--accent-color); font-size: 1.2rem; }
    .session-item { background-color: white; padding: 20px; border-radius: var(--border-radius); margin: 15px 0; box-shadow: var(--box-shadow); display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; transition: transform 0.3s ease; }
    .session-item:hover { transform: translateY(-3px); }
    .session-stat { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
    .daily-summary { background-color: #e8f4fc; padding: 20px; border-radius: var(--border-radius); margin: 20px 0; box-shadow: var(--box-shadow); }
    .daily-summary h4 { color: var(--primary-color); margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .daily-summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .daily-summary-stat { display: flex; flex-direction: column; align-items: center; }
    .daily-summary-stat .value { font-size: 1.5rem; font-weight: 600; color: var(--secondary-color); }
    .daily-summary-stat .label { font-size: 0.85rem; color: #666; margin-top: 5px; }
    .accuracy-high { color: var(--success-color); }
    .accuracy-medium { color: var(--warning-color); }
    .accuracy-low { color: var(--danger-color); }
    .hidden { display: none; }
    .progress-container { height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-top: 15px; overflow: hidden; }
    .progress-bar { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--accent-color), var(--primary-color)); width: 0%; transition: width 0.5s ease; }
    @media (max-width: 992px) {
      #sidebar { width: 70px; padding: 20px 10px; overflow: hidden; }
      #sidebar .logo h2, .sidebar-button span { display: none; }
      #sidebar .logo i { margin-right: 0; font-size: 1.8rem; }
      .sidebar-button { justify-content: center; padding: 12px 5px; }
      .sidebar-button i { margin-right: 0; font-size: 1.3rem; }
      #main-content { margin-left: 70px; padding-left: 20px; }
    }
    @media (max-width: 768px) {
      .today-stats { grid-template-columns: 1fr; }
      .exercises-section { grid-template-columns: 1fr; }
      .button-container { flex-direction: column; }
      #timer { font-size: 3rem; }
    }
  </style>
</head>

<body>
  <div id="sidebar">
    <div class="logo">
      <i class="fas fa-book-open"></i>
      <h2>Med Fácil</h2>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" class="sidebar-button active"><i class="fas fa-home"></i><span>Início</span></a></li>
      <li><a href="historico.html" class="sidebar-button"><i class="fas fa-history"></i><span>Histórico</span></a></li>
      <li><a href="conteudos.html" class="sidebar-button"><i class="fas fa-book"></i><span>Conteúdos</span></a></li>
      <li><a id="downloadButton" href="#" class="sidebar-button hidden"><i class="fas fa-download"></i><span>Exportar Dados</span></a></li>
      <li><a id="importButton" href="#" class="sidebar-button"><i class="fas fa-upload"></i><span>Importar Dados</span></a></li>
      <li><a id="btnLogout" href="#" class="sidebar-button"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></li>
    </ul>
  </div>

  <div id="main-content">
    <div class="header">
      <h1>Tracker de Estudos</h1>
    </div>
    <div class="today-stats">
      <div class="today-stat-card">
        <h3><i class="fas fa-clock"></i> Hoje estudado</h3>
        <p id="todayStudyTime">00:00:00</p>
      </div>
      <div class="today-stat-card">
        <h3><i class="fas fa-tasks"></i> Exercícios hoje</h3>
        <p id="todayExercises">0</p>
      </div>
    </div>

    <div class="timer-section">
      <div id="timer">00:00:00</div>
      <div class="button-container">
        <button id="startButton" class="button button-primary">
          <i class="fas fa-play"></i> Iniciar Estudo
        </button>
        <button id="stopButton" class="button button-danger hidden">
          <i class="fas fa-stop"></i> Parar e Salvar
        </button>
      </div>
    </div>

    <div class="exercises-section">
      <div class="input-group">
        <label for="subjectInput"><i class="fas fa-book-medical"></i> Grande Área:</label>
        <select id="subjectInput">
          <option value="Clínica Médica">Clínica Médica</option>
          <option value="Cirurgia Geral">Cirurgia Geral</option>
          <option value="Pediatria">Pediatria</option>
          <option value="Ginecologia e Obstetrícia">G.O.</option>
          <option value="Preventiva">Preventiva</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
      <div class="input-group">
        <label for="topicInput"><i class="fas fa-tag"></i> Assunto (Ex: Asma):</label>
        <input type="text" id="topicInput" placeholder="Digite o tema estudado...">
      </div>
    </div>

    <div class="exercises-section">
      <div class="input-group">
        <label for="exercisesInput"><i class="fas fa-tasks"></i> Exercícios Feitos:</label>
        <input type="number" id="exercisesInput" value="0" min="0">
      </div>
      <div class="input-group">
        <label for="correctExercisesInput"><i class="fas fa-check-circle"></i> Exercícios Corretos:</label>
        <input type="number" id="correctExercisesInput" value="0" min="0">
      </div>
    </div>

    <div class="stats-container">
      <div class="stat-card">
        <h3><i class="fas fa-clock"></i> Tempo Total</h3>
        <p id="totalStudyTime">00:00:00</p>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-calendar-week"></i> Esta Semana</h3>
        <p id="weeklyStudyTime">00:00:00</p>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-tasks"></i> Exercícios Feitos</h3>
        <p id="totalExercisesDone">0</p>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-check-circle"></i> Exercícios Corretos</h3>
        <p id="totalExercisesCorrect">0</p>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-bullseye"></i> Precisão Média</h3>
        <p id="averageAccuracy">0%</p>
      </div>
      <div class="stat-card">
        <h3><i class="fas fa-bullseye"></i> Meta Semanal</h3>
        <p>20 horas</p>
        <div class="progress-container">
          <div class="progress-bar" id="weeklyProgress"></div>
        </div>
      </div>
    </div>

    <div id="sessionList"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCWNFjeLIjBgDa5v3W5vsCdJ1PGDeHE35A",
      authDomain: "meu-study-tracker.firebaseapp.com",
      databaseURL: "https://meu-study-tracker-default-rtdb.firebaseio.com",
      projectId: "meu-study-tracker",
      storageBucket: "meu-study-tracker.firebasestorage.app",
      messagingSenderId: "715609213126",
      appId: "1:715609213126:web:3e9cbe7e840ea20a1b6fc7"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // GUARDA DE AUTENTICAÇÃO
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        console.log("Usuário logado:", user.uid);
        
        // Caminho do Banco de Dados
        const dbRef = database.ref('users/' + user.uid + '/sessionsByDate');

        let startTime;
        let timerInterval;
        let totalTime = 0;
        let sessionsByDate = {};

        const timerDisplay = document.getElementById('timer');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const sessionList = document.getElementById('sessionList');
        const downloadButton = document.getElementById('downloadButton');
        const totalStudyTimeDisplay = document.getElementById('totalStudyTime');
        const totalExercisesDoneDisplay = document.getElementById('totalExercisesDone');
        const totalExercisesCorrectDisplay = document.getElementById('totalExercisesCorrect');
        const averageAccuracyDisplay = document.getElementById('averageAccuracy');
        const weeklyStudyTimeDisplay = document.getElementById('weeklyStudyTime');
        const todayStudyTimeDisplay = document.getElementById('todayStudyTime');
        const todayExercisesDisplay = document.getElementById('todayExercises');
        const btnLogout = document.getElementById('btnLogout');
        const importButton = document.getElementById('importButton');
        const fileInput = document.createElement('input');

        function startStudySession() {
          startTime = new Date().getTime();
          timerInterval = setInterval(updateTimer, 1000);
          startButton.classList.add('hidden');
          stopButton.classList.remove('hidden');
        }

        // --- FUNÇÃO DE PARAR (OTIMIZADA E COM NOVOS CAMPOS) ---
        function stopStudySession() {
          clearInterval(timerInterval);
          startButton.classList.remove('hidden');
          stopButton.classList.add('hidden');

          const sessionTime = formatTime(totalTime);
          const exercisesInput = document.getElementById('exercisesInput');
          const correctExercisesInput = document.getElementById('correctExercisesInput');
          const exercisesDone = parseInt(exercisesInput.value);
          const exercisesCorrect = parseInt(correctExercisesInput.value);
          const currentDate = new Date();
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth() + 1;
          const day = currentDate.getDate();
          const dateKey = `${year}-${month}-${day}`;

          // Captura os novos campos
          const subjectInput = document.getElementById('subjectInput');
          const topicInput = document.getElementById('topicInput');
          const subject = subjectInput.value;
          const topic = topicInput.value || "Geral";

          if (!sessionsByDate[dateKey]) {
            sessionsByDate[dateKey] = [];
          }

          const accuracy = exercisesDone > 0 ? (exercisesCorrect / exercisesDone * 100).toFixed(2) : '0.00';

          const sessionData = {
            time: sessionTime,
            exercisesDone: exercisesDone,
            exercisesCorrect: exercisesCorrect,
            accuracy: accuracy,
            subject: subject, // Salva a área
            topic: topic      // Salva o assunto
          };

          // Atualiza Localmente
          sessionsByDate[dateKey].push(sessionData);

          // Envia para o Firebase (Sem baixar tudo de novo)
          dbRef.set(sessionsByDate)
            .then(() => {
              console.log("Dados salvos no Firebase!");
              inicializarDashboard(); // Atualiza a tela com os dados locais
            })
            .catch((error) => {
              console.error("Erro ao salvar:", error);
              if (error.code === 'PERMISSION_DENIED') {
                 alert("Sua conta gratuita atingiu o limite ou não está ativa. Fale conosco para assinar!");
              } else {
                 alert("Erro ao salvar. Verifique sua conexão.");
              }
              // Reverte a mudança local em caso de erro
              sessionsByDate[dateKey].pop();
            });

          totalTime = 0;
          updateDisplay();
          // Limpa o campo de assunto para a próxima sessão
          topicInput.value = '';
        }

        function getStartOfWeek(date) {
          const d = new Date(date);
          const day = d.getDay();
          const diff = d.getDate() - day + (day === 0 ? -6 : 1);
          d.setHours(0, 0, 0, 0);
          return new Date(d.setDate(diff));
        }

        function calculateWeeklyStudyTime() {
          const now = new Date();
          const startOfWeek = getStartOfWeek(now);
          let weeklyMilliseconds = 0;
          for (const dateKey in sessionsByDate) {
            if (sessionsByDate.hasOwnProperty(dateKey)) {
              const [year, month, day] = dateKey.split('-').map(Number);
              const sessionDate = new Date(year, month - 1, day);
              if (sessionDate >= startOfWeek) {
                sessionsByDate[dateKey].forEach(session => {
                  const timeParts = (session.time || "0:0:0").split(':').map(Number);
                  if(timeParts.length === 3) {
                    const [hours, minutes, seconds] = timeParts;
                    weeklyMilliseconds += (hours * 3600000) + (minutes * 60000) + (seconds * 1000);
                  }
                });
              }
            }
          }
          return formatTime(weeklyMilliseconds);
        }

        function calculateTodayStats() {
          const currentDate = new Date();
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth() + 1;
          const day = currentDate.getDate();
          const dateKey = `${year}-${month}-${day}`;
          let todayMilliseconds = 0;
          let todayExercises = 0;
          if (sessionsByDate[dateKey]) {
            sessionsByDate[dateKey].forEach(session => {
              const timeParts = (session.time || "0:0:0").split(':').map(Number);
              if(timeParts.length === 3) {
                const [hours, minutes, seconds] = timeParts;
                todayMilliseconds += (hours * 3600000) + (minutes * 60000) + (seconds * 1000);
              }
              todayExercises += session.exercisesDone || 0;
            });
          }
          return {
            time: formatTime(todayMilliseconds),
            exercises: todayExercises
          };
        }

        function updateTodayStats() {
          const todayStats = calculateTodayStats();
          todayStudyTimeDisplay.textContent = todayStats.time;
          todayExercisesDisplay.textContent = todayStats.exercises;
        }

        function updateWeeklyStudyTime() {
          weeklyStudyTimeDisplay.textContent = calculateWeeklyStudyTime();
        }

        function updateWeeklyProgress() {
          const weeklyTime = calculateWeeklyStudyTime();
          const [hours, minutes, seconds] = weeklyTime.split(':').map(Number);
          const totalHours = hours + (minutes / 60) + (seconds / 3600);
          const weeklyGoal = 20;
          const progress = Math.min((totalHours / weeklyGoal) * 100, 100);
          document.getElementById('weeklyProgress').style.width = `${progress}%`;
        }

        function getAccuracyClass(accuracy) {
          if (accuracy >= 80) return 'accuracy-high';
          if (accuracy >= 50) return 'accuracy-medium';
          return 'accuracy-low';
        }

        function updateSessionList() {
          sessionList.innerHTML = '';
          const sortedDates = Object.keys(sessionsByDate).sort((a, b) => {
            const dateA = new Date(a.split('-').join('/'));
            const dateB = new Date(b.split('-').join('/'));
            return dateB - dateA;
          });
          for (const date of sortedDates) {
            if (sessionsByDate.hasOwnProperty(date)) {
              const dateHeader = document.createElement('h3');
              dateHeader.className = 'session-date';
              dateHeader.textContent = formatDateDisplay(date);
              sessionList.appendChild(dateHeader);

              const dailySummary = document.createElement('div');
              dailySummary.className = 'daily-summary';
              const dailyTime = calculateDailyStudyTime(date);
              const dailyExercises = calculateDailyExercises(date);
              const accuracyClass = getAccuracyClass(parseFloat(dailyExercises.accuracy));
              dailySummary.innerHTML = `
                <h4><i class="fas fa-calendar-day"></i> Resumo do Dia</h4>
                <div class="daily-summary-stats">
                  <div class="daily-summary-stat">
                    <div class="value">${dailyTime}</div>
                    <div class="label">Tempo estudado</div>
                  </div>
                  <div class="daily-summary-stat">
                    <div class="value">${dailyExercises.totalExercises}</div>
                    <div class="label">Exercícios</div>
                  </div>
                  <div class="daily-summary-stat">
                    <div class="value">${dailyExercises.totalCorrect}</div>
                    <div class="label">Acertos</div>
                  </div>
                  <div class="daily-summary-stat ${accuracyClass}">
                    <div class="value">${dailyExercises.accuracy}%</div>
                    <div class="label">Precisão</div>
                  </div>
                </div>
              `;
              sessionList.appendChild(dailySummary);

              sessionsByDate[date].forEach((session, index) => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                const accuracyClass = getAccuracyClass(parseFloat(session.accuracy));
                // Mostra o Assunto na lista se existir
                const topicDisplay = session.topic ? ` - ${session.topic}` : '';
                const subjectDisplay = session.subject ? `(${session.subject})` : '';
                
                sessionItem.innerHTML = `
                  <div class="session-stat"><strong>Sessão ${index + 1} ${subjectDisplay}${topicDisplay}:</strong></div>
                  <div class="session-stat"><i class="fas fa-clock"></i> ${session.time || '00:00:00'}</div>
                  <div class="session-stat"><i class="fas fa-tasks"></i> ${session.exercisesDone || 0}</div>
                  <div class="session-stat"><i class="fas fa-check-circle"></i> ${session.exercisesCorrect || 0}</div>
                  <div class="session-stat ${accuracyClass}"><i class="fas fa-bullseye"></i> ${session.accuracy || 0}%</div>
                `;
                sessionList.appendChild(sessionItem);
              });
            }
          }
        }

        function calculateDailyStudyTime(dateKey) {
          let dailyMilliseconds = 0;
          if (sessionsByDate[dateKey]) {
            sessionsByDate[dateKey].forEach(session => {
              const timeParts = (session.time || "0:0:0").split(':').map(Number);
              if(timeParts.length === 3) {
                const [hours, minutes, seconds] = timeParts;
                dailyMilliseconds += (hours * 3600000) + (minutes * 60000) + (seconds * 1000);
              }
            });
          }
          return formatTime(dailyMilliseconds);
        }

        function calculateDailyExercises(dateKey) {
          let totalExercises = 0;
          let totalCorrect = 0;
          if (sessionsByDate[dateKey]) {
            sessionsByDate[dateKey].forEach(session => {
              totalExercises += session.exercisesDone || 0;
              totalCorrect += session.exercisesCorrect || 0;
            });
          }
          return {
            totalExercises: totalExercises,
            totalCorrect: totalCorrect,
            accuracy: totalExercises > 0 ? (totalCorrect / totalExercises * 100).toFixed(2) : '0.00'
          };
        }

        function formatDateDisplay(dateString) {
          const [year, month, day] = dateString.split('-');
          const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
          return `${day} de ${months[parseInt(month) - 1]} de ${year}`;
        }

        function updateTimer() {
          const currentTime = new Date().getTime();
          totalTime = currentTime - startTime;
          timerDisplay.textContent = formatTime(totalTime);
        }

        function formatTime(milliseconds) {
          const hours = Math.floor(milliseconds / 3600000);
          const minutes = Math.floor((milliseconds % 3600000) / 60000);
          const seconds = Math.floor((milliseconds % 60000) / 1000);
          return pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
        }

        function pad(num) {
          return num.toString().padStart(2, '0');
        }

        function updateDisplay() {
          document.getElementById('exercisesInput').value = 0;
          document.getElementById('correctExercisesInput').value = 0;
        }

        function updateTotalStudyTime() {
          let totalMilliseconds = 0;
          for (const date in sessionsByDate) {
            if (sessionsByDate.hasOwnProperty(date)) {
              const sessions = sessionsByDate[date];
              sessions.forEach(session => {
                const timeParts = (session.time || "0:0:0").split(':').map(Number);
                if(timeParts.length === 3) {
                  const [hours, minutes, seconds] = timeParts;
                  totalMilliseconds += (hours * 3600000) + (minutes * 60000) + (seconds * 1000);
                }
              });
            }
          }
          const totalFormatted = formatTime(totalMilliseconds);
          totalStudyTimeDisplay.textContent = totalFormatted;
        }

        function downloadData() {
          const dataStr = JSON.stringify(sessionsByDate, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'dados_estudo_medfacil.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        function importData(event) {
          const file = event.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const importedData = JSON.parse(e.target.result);
              if (typeof importedData === 'object' && importedData !== null) {
                if (confirm("Você quer MESCLAR estes dados com os seus dados na nuvem?\n\n(Clique em 'Cancelar' para SUBSTITUIR TUDO na nuvem com este arquivo.)")) {
                  const mergedData = { ...sessionsByDate, ...importedData };
                  dbRef.set(mergedData).then(() => {
                     alert('Dados mesclados com sucesso! A página será recarregada.');
                     location.reload();
                  });
                } else {
                  dbRef.set(importedData).then(() => {
                    alert('Dados substituídos com sucesso! A página será recarregada.');
                    location.reload();
                  });
                }
              } else {
                throw new Error("Formato de arquivo inválido.");
              }
            } catch (error) {
              alert('Erro ao importar o arquivo.');
              console.error("Erro na importação: ", error);
            }
          };
          reader.readAsText(file);
        }

        function calculateStatistics() {
          let totalExercisesDone = 0;
          let totalExercisesCorrect = 0;
          for (const date in sessionsByDate) {
            if (sessionsByDate.hasOwnProperty(date)) {
              sessionsByDate[date].forEach(session => {
                totalExercisesDone += session.exercisesDone || 0;
                totalExercisesCorrect += session.exercisesCorrect || 0;
              });
            }
          }
          let totalAccuracy = 0;
          if (totalExercisesDone > 0) {
            totalAccuracy = (totalExercisesCorrect / totalExercisesDone * 100).toFixed(2);
          }
          return {
            totalExercisesDone: totalExercisesDone,
            totalExercisesCorrect: totalExercisesCorrect,
            averageAccuracy: totalAccuracy
          };
        }

        function updateStatisticsDisplay() {
          const statistics = calculateStatistics();
          totalExercisesDoneDisplay.textContent = statistics.totalExercisesDone;
          totalExercisesCorrectDisplay.textContent = statistics.totalExercisesCorrect;
          averageAccuracyDisplay.textContent = `${statistics.averageAccuracy}%`;
        }
        
        function inicializarDashboard() {
          console.log("Atualizando dashboard com dados...");
          updateTotalStudyTime();
          updateStatisticsDisplay();
          updateWeeklyStudyTime();
          updateWeeklyProgress();
          updateSessionList();
          updateTodayStats();
        }

        // --- LÓGICA DE INICIALIZAÇÃO E LISTENERS ---

        fileInput.type = 'file';
        fileInput.accept = '.json, .txt';
        fileInput.style.display = 'none';
        fileInput.addEventListener('change', importData);
        document.body.appendChild(fileInput);

        importButton.addEventListener('click', () => fileInput.click());
        startButton.addEventListener('click', startStudySession);
        stopButton.addEventListener('click', stopStudySession);
        downloadButton.addEventListener('click', downloadData);
        
        btnLogout.addEventListener('click', (e) => {
          e.preventDefault();
          auth.signOut().then(() => {
            console.log('Usuário deslogado.');
          }).catch((error) => {
            console.error('Erro ao sair:', error);
          });
        });

        // =================================================================
        // --- OTIMIZAÇÃO: CARREGAMENTO INICIAL (UMA SÓ VEZ) ---
        // =================================================================
        try {
          console.log("Buscando dados do histórico (uma única vez)...");
          const snapshot = await dbRef.get();
          
          if (snapshot.exists()) {
            sessionsByDate = snapshot.val(); 
          } else {
            console.log("Nenhum dado encontrado para este usuário.");
            sessionsByDate = {}; 
          }
          
          inicializarDashboard();
          
          if (Object.keys(sessionsByDate).length > 0) {
            downloadButton.classList.remove('hidden');
          } else {
            downloadButton.classList.add('hidden');
          }
          
        } catch (errorObject) {
          console.error("A leitura do Firebase falhou:", errorObject);
        }

      } else {
        console.log("Usuário não logado. Redirecionando para login.html...");
        window.location.href = 'login.html'; 
      }
    });
    
  </script>
</body>
</html>
