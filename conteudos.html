<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Desempenho Detalhado</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- CSS BASE (Compatível com seu index) --- */
    :root { --primary-color: #4a6fa5; --secondary-color: #166088; --accent-color: #4fc3f7; --text-color: #333; --bg-color: #f5f7fa; --card-bg: #ffffff; --border-radius: 12px; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; min-height: 100vh; }
    
    /* Sidebar (Mantido igual) */
    #sidebar { width: 250px; background: linear-gradient(135deg, #2c3e50, #4a6fa5); color: white; padding: 30px 20px; position: fixed; height: 100%; z-index: 100; }
    #sidebar .logo { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
    #sidebar .logo h2 { color: white; font-weight: 500; }
    #sidebar .logo i { font-size: 2rem; margin-bottom: 10px; color: var(--accent-color); }
    .sidebar-menu { list-style: none; }
    .sidebar-button { display: flex; align-items: center; padding: 12px 15px; border-radius: 12px; color: white; text-decoration: none; margin-bottom: 10px; transition: 0.3s; }
    .sidebar-button:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
    .sidebar-button.active { background-color: var(--accent-color); color: #343a40; font-weight: 500; }
    .sidebar-button i { margin-right: 10px; width: 20px; text-align: center; }

    /* Layout Principal */
    #main-content { flex: 1; margin-left: 250px; padding: 40px; max-width: 1200px; margin: 0 auto; }
    
    /* --- ESTILOS NOVOS (BASEADOS NA IMAGEM) --- */
    
    /* Cabeçalho e Filtros */
    .dashboard-header { margin-bottom: 30px; }
    .page-title { color: var(--secondary-color); font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; }

    /* Abas de Filtro */
    .tabs-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; }
    .filter-tab {
      padding: 10px 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      color: #666;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .filter-tab:hover { transform: translateY(-2px); }
    .filter-tab.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 4px 10px rgba(74, 111, 165, 0.3);
    }

    /* Barra de Pesquisa e Ordenação */
    .controls-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .search-wrapper { flex: 2; position: relative; min-width: 250px; }
    .search-input {
      width: 100%;
      padding: 12px 45px 12px 20px;
      border-radius: 25px;
      border: 1px solid #ddd;
      outline: none;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #888; }
    
    .sort-wrapper { flex: 1; min-width: 200px; }
    .sort-select {
      width: 100%;
      padding: 12px 20px;
      border-radius: 25px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 600;
      outline: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* --- LISTA DE TÓPICOS (ESTILO IMAGEM) --- */
    .topics-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 40px; }
    .topics-header { display: flex; justify-content: space-between; color: #888; font-weight: 500; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    
    .topic-row {
      display: flex;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #f5f5f5;
      transition: background 0.2s;
    }
    .topic-row:hover { background-color: #fafafa; }
    
    .topic-name { flex: 3; font-weight: 500; color: #444; padding-right: 20px; }
    
    .topic-progress-area { flex: 4; display: flex; align-items: center; gap: 15px; }
    .progress-track { flex: 1; height: 12px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 10px; transition: width 1s ease; }
    
    /* Cores das barras */
    .bar-blue { background-color: #00acc1; } /* Cor turquesa da imagem */
    .bar-gray { background-color: #546e7a; } /* Para 0% */
    
    .topic-percentage { width: 50px; text-align: right; font-weight: 700; color: #555; }

    /* --- GRÁFICO FINAL (CORRIGIDO) --- */
    .chart-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      text-align: center;
    }
    .chart-wrapper {
      position: relative;
      height: 400px;
      width: 100%;
      max-width: 600px; /* Impede que fique gigante */
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      #main-content { margin-left: 0; padding-top: 80px; }
      #sidebar { width: 100%; height: auto; position: fixed; top: 0; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
      .sidebar-menu { display: none; } /* Simplificado para mobile */
      .topic-row { flex-direction: column; align-items: flex-start; gap: 10px; }
      .topic-progress-area { width: 100%; }
      .controls-row { flex-direction: column; }
    }
  </style>
</head>
<body>

<div id="sidebar">
  <div class="logo">
    <i class="fas fa-book-open"></i>
    <h2>Med Fácil</h2>
  </div>
  <ul class="sidebar-menu">
    <li><a href="index.html" class="sidebar-button"><i class="fas fa-home"></i><span>Início</span></a></li>
    <li><a href="historico.html" class="sidebar-button"><i class="fas fa-history"></i><span>Histórico</span></a></li>
    <li><a href="#" class="sidebar-button active"><i class="fas fa-book"></i><span>Conteúdos</span></a></li>
    <li><a id="btnLogout" href="#" class="sidebar-button"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></li>
  </ul>
</div>

<div id="main-content">
  
  <div class="dashboard-header">
    <h1 class="page-title">Desempenho por Área</h1>
    
    <div class="tabs-container" id="tabsContainer">
      <div class="filter-tab active" data-filter="all">Geral</div>
      <div class="filter-tab" data-filter="Cirurgia Geral">Cirurgia</div>
      <div class="filter-tab" data-filter="Clínica Médica">Clínica Médica</div>
      <div class="filter-tab" data-filter="Pediatria">Pediatria</div>
      <div class="filter-tab" data-filter="Ginecologia e Obstetrícia">G.O.</div>
      <div class="filter-tab" data-filter="Preventiva">Preventiva</div>
    </div>

    <div class="controls-row">
      <div class="search-wrapper">
        <input type="text" class="search-input" id="searchInput" placeholder="Pesquisar assunto...">
        <i class="fas fa-search search-icon"></i>
      </div>
      <div class="sort-wrapper">
        <select class="sort-select" id="sortSelect">
          <option value="az">Ordem alfabética</option>
          <option value="performance_desc">Maior acerto</option>
          <option value="performance_asc">Menor acerto</option>
          <option value="questions">Mais questões</option>
        </select>
      </div>
    </div>
  </div>

  <div id="loading-message" style="text-align: center; color: #666; margin-top: 50px;">
    <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Carregando seus dados...
  </div>

  <div class="topics-container" id="topicsContainer" style="display: none;">
    <div class="topics-header">
      <span>Assunto / Especialidade</span>
      <span>% de questões corretas</span>
    </div>
    <div id="topicsList">
      </div>
  </div>

  <div class="chart-section" id="chartSection" style="display: none;">
    <h3 style="color: var(--secondary-color); margin-bottom: 20px;">Análise Geral das Áreas</h3>
    <div class="chart-wrapper">
      <canvas id="skillsChart"></canvas>
    </div>
  </div>

</div>

<script>
  // === CONFIGURAÇÃO DO FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyCWNFjeLIjBgDa5v3W5vsCdJ1PGDeHE35A",
    authDomain: "meu-study-tracker.firebaseapp.com",
    databaseURL: "https://meu-study-tracker-default-rtdb.firebaseio.com",
    projectId: "meu-study-tracker",
    storageBucket: "meu-study-tracker.firebasestorage.app",
    messagingSenderId: "715609213126",
    appId: "1:715609213126:web:3e9cbe7e840ea20a1b6fc7"
  };

  let database, auth;
  try {
    const app = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    auth = firebase.auth(); 
  } catch (error) { console.error(error); }

  // --- VARIÁVEIS GLOBAIS ---
  let allSubjectsData = {}; // Guarda todos os dados processados
  let currentFilter = 'all';
  let currentSort = 'az';
  let chartInstance = null;

  // --- PROCESSAMENTO DE DADOS ---
  function processData(sessionsByDate) {
    const subjects = {}; 

    for (const date in sessionsByDate) {
      sessionsByDate[date].forEach(session => {
        const subjectName = session.subject || 'Sem Categoria';
        const topicName = (session.topic && session.topic.trim() !== "") ? session.topic : 'Geral';

        // Se não existe a Grande Área, cria
        if (!subjects[subjectName]) {
          subjects[subjectName] = {
            totalQuestions: 0,
            totalCorrect: 0,
            topics: {}
          };
        }

        // Dados da Grande Área
        subjects[subjectName].totalQuestions += (session.exercisesDone || 0);
        subjects[subjectName].totalCorrect += (session.exercisesCorrect || 0);

        // Se não existe o Tópico, cria
        if (!subjects[subjectName].topics[topicName]) {
          subjects[subjectName].topics[topicName] = {
            questions: 0,
            correct: 0
          };
        }

        // Dados do Tópico
        const tStat = subjects[subjectName].topics[topicName];
        tStat.questions += (session.exercisesDone || 0);
        tStat.correct += (session.exercisesCorrect || 0);
      });
    }

    allSubjectsData = subjects;
    renderInterface();
  }

  // --- RENDERIZAÇÃO PRINCIPAL ---
  function renderInterface() {
    renderTopicList();
    renderChart();
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('topicsContainer').style.display = 'block';
    document.getElementById('chartSection').style.display = 'block';
  }

  // --- RENDERIZAR A LISTA ---
  function renderTopicList() {
    const listContainer = document.getElementById('topicsList');
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
    listContainer.innerHTML = '';

    let flatList = [];

    // 1. Achatar a lista (pegar tópicos de dentro das áreas)
    for (const [areaName, areaData] of Object.entries(allSubjectsData)) {
      // Filtro por aba (Grande Área)
      if (currentFilter !== 'all' && areaName !== currentFilter) continue;

      for (const [topicName, stats] of Object.entries(areaData.topics)) {
        // Filtro de pesquisa
        if (searchQuery && !topicName.toLowerCase().includes(searchQuery)) continue;

        const accuracy = stats.questions > 0 ? (stats.correct / stats.questions * 100) : 0;
        flatList.push({
          area: areaName,
          name: topicName,
          accuracy: accuracy,
          questions: stats.questions
        });
      }
    }

    // 2. Ordenação
    flatList.sort((a, b) => {
      if (currentSort === 'az') return a.name.localeCompare(b.name);
      if (currentSort === 'performance_desc') return b.accuracy - a.accuracy;
      if (currentSort === 'performance_asc') return a.accuracy - b.accuracy;
      if (currentSort === 'questions') return b.questions - a.questions;
    });

    // 3. Gerar HTML
    if (flatList.length === 0) {
      listContainer.innerHTML = '<p style="text-align:center; padding:20px;">Nenhum tópico encontrado.</p>';
      return;
    }

    flatList.forEach(item => {
      // Cor da barra
      let barClass = 'bar-blue'; // Turquesa padrão
      if (item.questions === 0) barClass = 'bar-gray';
      
      // HTML da Linha
      const html = `
        <div class="topic-row">
          <div class="topic-name">
            ${item.name} 
            <span style="font-size:0.8rem; color:#999; margin-left:5px;">(${item.area})</span>
          </div>
          <div class="topic-progress-area">
            <div class="progress-track">
              <div class="progress-fill ${barClass}" style="width: ${item.accuracy}%"></div>
            </div>
            <div class="topic-percentage">${item.accuracy.toFixed(0)}%</div>
          </div>
        </div>
      `;
      listContainer.innerHTML += html;
    });
  }

  // --- RENDERIZAR GRÁFICO (ARANHA) ---
  function renderChart() {
    const ctx = document.getElementById('skillsChart').getContext('2d');
    
    // Preparar dados das Grandes Áreas
    const labels = [];
    const dataPoints = [];

    // Áreas fixas para o gráfico ficar bonito (opcional)
    const mainAreas = ["Clínica Médica", "Cirurgia Geral", "Pediatria", "Ginecologia e Obstetrícia", "Preventiva"];
    
    mainAreas.forEach(area => {
      labels.push(area);
      if (allSubjectsData[area] && allSubjectsData[area].totalQuestions > 0) {
        const acc = (allSubjectsData[area].totalCorrect / allSubjectsData[area].totalQuestions * 100);
        dataPoints.push(acc.toFixed(1));
      } else {
        dataPoints.push(0);
      }
    });

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Percentual de Acertos (%)',
          data: dataPoints,
          backgroundColor: 'rgba(0, 172, 193, 0.2)', // Turquesa transparente
          borderColor: '#00acc1', // Turquesa
          pointBackgroundColor: '#fff',
          pointBorderColor: '#00acc1',
          pointHoverBackgroundColor: '#00acc1',
          pointHoverBorderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, // Importante para fixar no container
        scales: {
          r: {
            angleLines: { display: true, color: '#eee' },
            grid: { color: '#eee' },
            suggestedMin: 0,
            suggestedMax: 100,
            ticks: { stepSize: 20, backdropColor: 'transparent', display: false } // Limpa os números do eixo
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  // --- EVENT LISTENERS ---
  window.addEventListener('load', () => {
    
    // Setup das Abas
    const tabs = document.querySelectorAll('.filter-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active de todos
        tabs.forEach(t => t.classList.remove('active'));
        // Adiciona no clicado
        tab.classList.add('active');
        // Atualiza filtro
        currentFilter = tab.getAttribute('data-filter');
        renderTopicList();
      });
    });

    // Setup da Busca e Ordenação
    document.getElementById('searchInput').addEventListener('input', renderTopicList);
    document.getElementById('sortSelect').addEventListener('change', (e) => {
      currentSort = e.target.value;
      renderTopicList();
    });

    // Auth e Load de Dados
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // Botão Sair
        const btnLogout = document.getElementById('btnLogout');
        if(btnLogout) btnLogout.addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut().then(() => window.location.href = 'login.html');
        });

        try {
          // Busca Otimizada (uma vez)
          const snapshot = await database.ref('users/' + user.uid + '/sessionsByDate').get();
          if (snapshot.exists()) {
            processData(snapshot.val());
          } else {
            document.getElementById('loading-message').innerHTML = "Sem dados. Comece a estudar!";
          }
        } catch (error) {
          console.error(error);
        }
      } else {
        window.location.href = 'login.html';
      }
    });
  });
</script>
</body>
</html>
