<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda de Revis√µes</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <style>
    /* --- CSS GERAL --- */
    :root { --primary-color: #4a6fa5; --secondary-color: #166088; --accent-color: #4fc3f7; --success-color: #4caf50; --warning-color: #ff9800; --danger-color: #f44336; --bg-color: #f5f7fa; --border-radius: 12px; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: #333; display: flex; min-height: 100vh; overflow-x: hidden; }
    
    /* Sidebar */
    #sidebar { width: 250px; background: linear-gradient(135deg, #2c3e50, #4a6fa5); color: white; padding: 30px 20px; position: fixed; height: 100%; z-index: 1000; top: 0; left: 0; transition: transform 0.3s; }
    #sidebar .logo { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
    #sidebar .logo h2 { color: white; font-weight: 500; }
    #sidebar .logo i { font-size: 2rem; margin-bottom: 10px; color: var(--accent-color); }
    .sidebar-menu { list-style: none; padding: 0; }
    .sidebar-button { display: flex; align-items: center; padding: 12px 15px; border-radius: 12px; color: white; text-decoration: none; margin-bottom: 10px; transition: 0.3s; }
    .sidebar-button:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
    .sidebar-button.active { background-color: var(--accent-color); color: #343a40; font-weight: 500; }
    .sidebar-button i { margin-right: 10px; width: 20px; text-align: center; }
    
    /* Bot√£o Mobile */
    .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
    #sidebar-overlay.show { display: block; }

    /* Content */
    #main-content { flex: 1; margin-left: 250px; padding: 30px; max-width: 1400px; width: calc(100% - 250px); margin-right: auto; transition: margin-left 0.3s ease, width 0.3s ease; }
    .header { margin-bottom: 30px; }
    .header h1 { color: var(--primary-color); font-weight: 500; }

    /* --- SE√á√ÉO PONTOS FRACOS --- */
    .weak-spots-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 40px;
        border-left: 5px solid var(--danger-color);
    }
    .weak-header { margin-bottom: 15px; }
    .weak-header h2 { color: var(--danger-color); font-size: 1.2rem; margin: 0; display: flex; align-items: center; gap: 10px; }
    
    .weak-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
    
    .weak-card {
        background: #ffebee;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ffcdd2;
    }
    .weak-topic { font-weight: bold; color: #c62828; margin-bottom: 5px; font-size: 0.95rem; }
    .weak-area { font-size: 0.8rem; color: #b71c1c; margin-bottom: 10px; }
    .weak-stat { display: flex; justify-content: space-between; font-size: 0.85rem; color: #333; font-weight: 500; }
    .weak-score { color: var(--danger-color); font-weight: bold; }

    /* --- LISTA DE REVIS√ïES --- */
    .reviews-section { margin-bottom: 40px; }
    .reviews-section h2 { font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .badge-count { background: var(--secondary-color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 10px; }

    .review-list { display: flex; flex-direction: column; gap: 10px; }

    .review-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        border-left: 4px solid #ccc;
        transition: transform 0.2s;
    }
    .review-item:hover { transform: translateX(5px); }

    /* Status Cores */
    .status-late { border-left-color: var(--danger-color); }
    .status-today { border-left-color: var(--success-color); }
    .status-future { border-left-color: var(--primary-color); }

    .review-info h3 { font-size: 1rem; color: #333; margin: 0 0 5px 0; }
    .review-sub { font-size: 0.85rem; color: #666; display: flex; gap: 15px; flex-wrap: wrap; }
    .review-date { font-weight: 500; color: var(--secondary-color); }

    .review-action { 
        font-size: 0.85rem; 
        color: #555; 
        background: #f0f0f0; 
        padding: 6px 12px; 
        border-radius: 20px; 
        white-space: nowrap;
    }
    
    .status-late .review-action { background: #ffebee; color: var(--danger-color); font-weight: bold; }
    .status-today .review-action { background: #e8f5e9; color: var(--success-color); font-weight: bold; }

    .empty-state { text-align: center; padding: 30px; color: #999; font-style: italic; background: white; border-radius: 8px; }

    @media (max-width: 900px) {
      #sidebar { transform: translateX(-100%); width: 260px; }
      #sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
      .mobile-menu-btn { display: block; }
      #main-content { margin-left: 0; width: 100%; padding: 15px; padding-top: 70px; }
      
      .review-item { flex-direction: column; align-items: flex-start; gap: 10px; }
      .review-action { align-self: flex-start; }
      .weak-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
  <div class="logo"><i class="fas fa-book-open"></i><h2>Med F√°cil</h2></div>
  <ul class="sidebar-menu">
    <li><a href="index.html" class="sidebar-button"><i class="fas fa-home"></i><span>In√≠cio</span></a></li>
    <li><a href="historico.html" class="sidebar-button"><i class="fas fa-history"></i><span>Hist√≥rico</span></a></li>
    <li><a href="conteudos.html" class="sidebar-button"><i class="fas fa-book"></i><span>Conte√∫dos</span></a></li>
    <li><a href="#" class="sidebar-button active"><i class="fas fa-sync-alt"></i><span>Revis√µes</span></a></li>
    <li><a id="btnLogout" href="#" class="sidebar-button"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></li>
  </ul>
</div>

<div id="main-content">
  <div class="header">
    <h1>Agenda de Revis√µes</h1>
  </div>

  <div id="loading" style="text-align:center; margin-top:50px;"><i class="fas fa-spinner fa-spin fa-2x" style="color:#666"></i></div>

  <div class="weak-spots-section" id="weakSection" style="display:none;">
    <div class="weak-header">
      <h2><i class="fas fa-exclamation-triangle"></i> Prioridade de Estudo (Menor % de Acerto)</h2>
    </div>
    <div id="weakSpotsGrid" class="weak-grid"></div>
  </div>

  <div class="reviews-section" id="pendingSection" style="display:none;">
    <h2><i class="fas fa-bell"></i> Pendentes <span id="badgePending" class="badge-count">0</span></h2>
    <div id="pendingList" class="review-list"></div>
  </div>

  <div class="reviews-section" id="futureSection" style="display:none;">
    <h2><i class="fas fa-calendar-alt"></i> Pr√≥ximas <span id="badgeFuture" class="badge-count">0</span></h2>
    <div id="futureList" class="review-list"></div>
  </div>

</div>

<script>
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebar-overlay').classList.toggle('show');
  }

  // Configura√ß√£o Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCWNFjeLIjBgDa5v3W5vsCdJ1PGDeHE35A",
    authDomain: "meu-study-tracker.firebaseapp.com",
    databaseURL: "https://meu-study-tracker-default-rtdb.firebaseio.com",
    projectId: "meu-study-tracker",
    storageBucket: "meu-study-tracker.firebasestorage.app",
    messagingSenderId: "715609213126",
    appId: "1:715609213126:web:3e9cbe7e840ea20a1b6fc7"
  };

  let database, auth;
  try {
    const app = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    auth = firebase.auth(); 
  } catch (error) { console.error(error); }

  window.addEventListener('load', () => {
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        document.getElementById('btnLogout').addEventListener('click', (e)=>{e.preventDefault(); auth.signOut().then(()=>window.location.href='login.html');});
        
        await loadAllData(user.uid);
      } else {
        window.location.href = 'login.html';
      }
    });
  });

  async function loadAllData(uid) {
    try {
      // Busca Hist√≥rico (para Pontos Fracos) e Revis√µes (para Agenda)
      const [sessionsSnap, reviewsSnap] = await Promise.all([
        database.ref('users/' + uid + '/sessionsByDate').get(),
        database.ref('users/' + uid + '/reviews').get()
      ]);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('weakSection').style.display = 'block';
      document.getElementById('pendingSection').style.display = 'block';
      document.getElementById('futureSection').style.display = 'block';

      calculateWeakSpots(sessionsSnap.exists() ? sessionsSnap.val() : {});
      renderSchedule(reviewsSnap.exists() ? reviewsSnap.val() : {});

    } catch (e) { console.error(e); }
  }

  // --- RENDERIZAR AGENDA (SEM BOT√ïES) ---
  function renderSchedule(reviews) {
    const pendingList = document.getElementById('pendingList');
    const futureList = document.getElementById('futureList');
    pendingList.innerHTML = '';
    futureList.innerHTML = '';

    const list = Object.values(reviews).sort((a, b) => new Date(a.nextReview) - new Date(b.nextReview));
    const today = new Date(); today.setHours(0,0,0,0);

    let countPending = 0;
    let countFuture = 0;

    if(list.length === 0) {
        pendingList.innerHTML = '<div class="empty-state">Nenhuma revis√£o agendada. Resolva quest√µes no Tracker para come√ßar!</div>';
        futureList.innerHTML = '<div class="empty-state">Sua agenda futura aparecer√° aqui.</div>';
        return;
    }

    list.forEach(r => {
      const rDate = new Date(r.nextReview); rDate.setHours(0,0,0,0);
      const diffDays = Math.ceil((rDate - today) / (1000 * 60 * 60 * 24));
      
      let statusClass = 'status-future';
      let statusText = `Em ${diffDays} dias`;
      let actionText = "Agendado";

      if (diffDays < 0) {
        statusClass = 'status-late';
        statusText = `Atrasado ${Math.abs(diffDays)} dias`;
        actionText = "Revisar Urgente";
        countPending++;
      } else if (diffDays === 0) {
        statusClass = 'status-today';
        statusText = "Hoje";
        actionText = "Revisar Hoje";
        countPending++;
      } else {
        countFuture++;
      }

      const html = `
        <div class="review-item ${statusClass}">
          <div class="review-info">
            <h3>${r.topic} <span style="font-weight:normal; font-size:0.85rem; color:#888;">(${r.subject})</span></h3>
            <div class="review-sub">
              <span class="review-date"><i class="far fa-calendar-alt"></i> ${statusText}</span>
              <span>${new Date(r.nextReview).toLocaleDateString()}</span>
              <span>N√≠vel: ${r.level || 1}</span>
            </div>
          </div>
          <div class="review-action">
            ${actionText}
          </div>
        </div>
      `;

      if (diffDays <= 0) pendingList.innerHTML += html;
      else futureList.innerHTML += html;
    });

    document.getElementById('badgePending').textContent = countPending;
    document.getElementById('badgeFuture').textContent = countFuture;

    if(countPending === 0) pendingList.innerHTML = '<div class="empty-state">üéâ Tudo em dia! Nenhuma revis√£o pendente.</div>';
    if(countFuture === 0) futureList.innerHTML = '<div class="empty-state">Nenhuma revis√£o futura agendada.</div>';
  }

  // --- PONTOS FRACOS ---
  function calculateWeakSpots(sessionsByDate) {
    const topicsStats = {};

    for (const date in sessionsByDate) {
      sessionsByDate[date].forEach(s => {
        const topic = s.topic || "Geral";
        if(topic === "Geral") return;

        if (!topicsStats[topic]) topicsStats[topic] = { correct: 0, total: 0, subject: s.subject };
        topicsStats[topic].correct += (s.exercisesCorrect || 0);
        topicsStats[topic].total += (s.exercisesDone || 0);
      });
    }

    const topicsArray = Object.keys(topicsStats).map(name => {
      const t = topicsStats[name];
      return {
        name: name,
        subject: t.subject || 'Geral',
        accuracy: t.total > 0 ? (t.correct / t.total * 100) : 0,
        total: t.total
      };
    });

    // Filtra (> 5 quest√µes) e Ordena (Pior desempenho primeiro)
    const weakSpots = topicsArray
      .filter(t => t.total >= 5) 
      .sort((a, b) => a.accuracy - b.accuracy)
      .slice(0, 4); 

    const container = document.getElementById('weakSpotsGrid');
    container.innerHTML = '';

    if (weakSpots.length === 0) {
      container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#666;">Continue estudando para gerarmos recomenda√ß√µes personalizadas (m√≠nimo 5 quest√µes por tema).</div>';
      return;
    }

    weakSpots.forEach(item => {
      let color = '#d32f2f'; 
      if(item.accuracy >= 50) color = '#f57c00';

      const html = `
        <div class="weak-card">
          <div class="weak-topic">${item.name}</div>
          <div class="weak-area">${item.subject}</div>
          <div class="weak-stat">
            <span>${item.total} quest√µes</span>
            <span class="weak-score" style="color:${color}">${item.accuracy.toFixed(0)}%</span>
          </div>
          <div style="width:100%; height:6px; background:rgba(0,0,0,0.1); margin-top:8px; border-radius:3px;">
             <div style="width:${item.accuracy}%; height:100%; background:${color}; border-radius:3px;"></div>
          </div>
        </div>
      `;
      container.innerHTML += html;
    });
  }

  // Fecha sidebar mobile ao clicar fora
  document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('sidebar');
    const btn = document.querySelector('.mobile-menu-btn');
    if(window.innerWidth <= 900 && !sidebar.contains(e.target) && !btn.contains(e.target)) {
      sidebar.classList.remove('open');
      document.getElementById('sidebar-overlay').classList.remove('show');
    }
  });
</script>
</body>
</html>
