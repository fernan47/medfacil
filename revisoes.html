<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Central de Revis√µes</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <style>
    /* --- CSS GERAL (Compat√≠vel) --- */
    :root { --primary-color: #4a6fa5; --secondary-color: #166088; --accent-color: #4fc3f7; --success-color: #4caf50; --warning-color: #ff9800; --danger-color: #f44336; --bg-color: #f5f7fa; --border-radius: 12px; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: #333; display: flex; min-height: 100vh; overflow-x: hidden; }
    
    /* Sidebar */
    #sidebar { width: 250px; background: linear-gradient(135deg, #2c3e50, #4a6fa5); color: white; padding: 30px 20px; position: fixed; height: 100%; z-index: 1000; top: 0; left: 0; transition: transform 0.3s; }
    #sidebar .logo { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
    #sidebar .logo h2 { color: white; font-weight: 500; }
    #sidebar .logo i { font-size: 2rem; margin-bottom: 10px; color: var(--accent-color); }
    .sidebar-menu { list-style: none; }
    .sidebar-button { display: flex; align-items: center; padding: 12px 15px; border-radius: 12px; color: white; text-decoration: none; margin-bottom: 10px; transition: 0.3s; }
    .sidebar-button:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
    .sidebar-button.active { background-color: var(--accent-color); color: #343a40; font-weight: 500; }
    .sidebar-button i { margin-right: 10px; width: 20px; text-align: center; }
    .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
    #sidebar-overlay.show { display: block; }

    /* Content */
    #main-content { flex: 1; margin-left: 250px; padding: 30px; max-width: 1400px; width: calc(100% - 250px); margin-right: auto; transition: margin-left 0.3s ease, width 0.3s ease; }
    .header { margin-bottom: 30px; }
    .header h1 { color: var(--primary-color); font-weight: 500; }

    /* --- DASHBOARD DE REVIS√ÉO (NOVO) --- */
    .review-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .review-stat {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      text-align: center;
      border-bottom: 4px solid transparent;
    }
    .review-stat.due { border-color: var(--danger-color); }
    .review-stat.today { border-color: var(--success-color); }
    .review-stat h3 { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
    .review-stat p { font-size: 2rem; font-weight: bold; color: #333; margin: 0; }

    /* --- FILTROS/ABAS --- */
    .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .tab-btn {
      padding: 8px 20px;
      background: #e0e0e0;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      color: #555;
      transition: 0.3s;
      white-space: nowrap;
    }
    .tab-btn.active { background: var(--primary-color); color: white; }
    .tab-btn.urgent { background: #ffebee; color: var(--danger-color); border: 1px solid var(--danger-color); }
    .tab-btn.urgent.active { background: var(--danger-color); color: white; }

    /* --- CARDS DE REVIS√ÉO (INTERATIVOS) --- */
    .reviews-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .review-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      position: relative;
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-left: 5px solid #ccc;
    }
    
    .review-card:hover { transform: translateY(-3px); }

    /* Status Colors */
    .card-status-late { border-left-color: var(--danger-color); }
    .card-status-today { border-left-color: var(--success-color); }
    .card-status-future { border-left-color: var(--primary-color); }

    .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.8rem; color: #666; }
    .card-badge { background: #eee; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
    
    .card-body h3 { font-size: 1.1rem; color: #333; margin-bottom: 5px; }
    .card-body p { font-size: 0.9rem; color: #666; margin-bottom: 15px; }

    /* Bot√µes de A√ß√£o (SRS) */
    .card-actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 5px;
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }

    .srs-btn {
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: bold;
      transition: 0.2s;
      color: white;
    }
    
    .btn-hard { background-color: #ef5350; } /* Reset */
    .btn-good { background-color: #66bb6a; } /* Next Cycle */
    .btn-easy { background-color: #42a5f5; } /* Jump Cycle */
    
    .srs-btn:hover { opacity: 0.9; transform: scale(1.05); }
    
    /* Esconde bot√µes se for revis√£o futura */
    .future-actions { display: none; }
    .card-status-future .card-actions { display: none; }
    .card-status-future .future-text { display: block; text-align: center; color: #888; font-size: 0.9rem; margin-top: 10px;}
    .future-text { display: none; }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 50px;
      background: white;
      border-radius: 12px;
      color: #888;
    }

    @media (max-width: 900px) {
      #sidebar { transform: translateX(-100%); width: 260px; }
      #sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
      .mobile-menu-btn { display: block; }
      #main-content { margin-left: 0; width: 100%; padding: 15px; padding-top: 70px; }
    }
  </style>
</head>
<body>

<button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
  <div class="logo"><i class="fas fa-book-open"></i><h2>Med F√°cil</h2></div>
  <ul class="sidebar-menu">
    <li><a href="index.html" class="sidebar-button"><i class="fas fa-home"></i><span>In√≠cio</span></a></li>
    <li><a href="historico.html" class="sidebar-button"><i class="fas fa-history"></i><span>Hist√≥rico</span></a></li>
    <li><a href="conteudos.html" class="sidebar-button"><i class="fas fa-book"></i><span>Conte√∫dos</span></a></li>
    <li><a href="#" class="sidebar-button active"><i class="fas fa-sync-alt"></i><span>Revis√µes</span></a></li>
    <li><a id="btnLogout" href="#" class="sidebar-button"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></li>
  </ul>
</div>

<div id="main-content">
  <div class="header">
    <h1>Central de Revis√µes</h1>
    <p style="color: #666;">Utilize a Repeti√ß√£o Espa√ßada para fixar o conte√∫do.</p>
  </div>

  <div class="review-dashboard">
    <div class="review-stat due">
      <h3>Atrasadas</h3>
      <p id="countLate">0</p>
    </div>
    <div class="review-stat today">
      <h3>Para Hoje</h3>
      <p id="countToday">0</p>
    </div>
    <div class="review-stat">
      <h3>Total Agendado</h3>
      <p id="countTotal">0</p>
    </div>
  </div>

  <div class="filter-tabs">
    <button class="tab-btn urgent active" onclick="filterReviews('active')">Pendentes (Hoje + Atraso)</button>
    <button class="tab-btn" onclick="filterReviews('future')">Futuras</button>
    <button class="tab-btn" onclick="filterReviews('all')">Todas</button>
  </div>

  <div id="loading" style="text-align:center; margin-top:50px;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
  <div id="reviewsContainer" class="reviews-grid"></div>
</div>

<script>
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebar-overlay').classList.toggle('show');
  }

  const firebaseConfig = {
    apiKey: "AIzaSyCWNFjeLIjBgDa5v3W5vsCdJ1PGDeHE35A",
    authDomain: "meu-study-tracker.firebaseapp.com",
    databaseURL: "https://meu-study-tracker-default-rtdb.firebaseio.com",
    projectId: "meu-study-tracker",
    storageBucket: "meu-study-tracker.firebasestorage.app",
    messagingSenderId: "715609213126",
    appId: "1:715609213126:web:3e9cbe7e840ea20a1b6fc7"
  };

  let database, auth;
  try {
    const app = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    auth = firebase.auth(); 
  } catch (error) { console.error(error); }

  // --- ESTADO ---
  let allReviews = [];
  let currentFilter = 'active'; // active, future, all

  // --- INTERVALOS DE REVIS√ÉO (Em Dias) ---
  // 1 = 1 dia depois, 7 = 1 semana depois, etc.
  const INTERVALS = [1, 3, 7, 15, 30, 60, 120];

  window.addEventListener('load', () => {
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        document.getElementById('btnLogout').addEventListener('click', (e)=>{e.preventDefault(); auth.signOut().then(()=>window.location.href='login.html');});
        loadReviews(user.uid);
      } else {
        window.location.href = 'login.html';
      }
    });
  });

  async function loadReviews(uid) {
    try {
      const snapshot = await database.ref('users/' + uid + '/reviews').get();
      document.getElementById('loading').style.display = 'none';
      
      if (snapshot.exists()) {
        const data = snapshot.val();
        // Converte objeto em array e adiciona a chave (key)
        allReviews = Object.keys(data).map(key => ({ id: key, ...data[key] }));
        updateDashboard();
        renderReviews();
      } else {
        document.getElementById('reviewsContainer').innerHTML = '<div class="empty-state">Nenhuma revis√£o agendada. Estude um tema no Tracker para come√ßar!</div>';
      }
    } catch (e) { console.error(e); }
  }

  function updateDashboard() {
    const today = new Date(); today.setHours(0,0,0,0);
    let late=0, due=0;
    
    allReviews.forEach(r => {
      const date = new Date(r.nextReview); date.setHours(0,0,0,0);
      if (date < today) late++;
      else if (date.getTime() === today.getTime()) due++;
    });

    document.getElementById('countLate').textContent = late;
    document.getElementById('countToday').textContent = due;
    document.getElementById('countTotal').textContent = allReviews.length;
  }

  function filterReviews(type) {
    currentFilter = type;
    // Atualiza UI dos bot√µes
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderReviews();
  }

  function renderReviews() {
    const container = document.getElementById('reviewsContainer');
    container.innerHTML = '';
    
    const today = new Date(); today.setHours(0,0,0,0);

    // Filtragem
    let filtered = allReviews.filter(r => {
      const rDate = new Date(r.nextReview); rDate.setHours(0,0,0,0);
      if (currentFilter === 'active') return rDate <= today;
      if (currentFilter === 'future') return rDate > today;
      return true;
    });

    // Ordena√ß√£o: Atrasados primeiro
    filtered.sort((a, b) => new Date(a.nextReview) - new Date(b.nextReview));

    if (filtered.length === 0) {
      container.innerHTML = '<div class="empty-state">Sem revis√µes nesta categoria! üéâ</div>';
      return;
    }

    filtered.forEach(r => {
      const rDate = new Date(r.nextReview); rDate.setHours(0,0,0,0);
      const diffDays = Math.ceil((rDate - today) / (1000 * 60 * 60 * 24));
      
      let status = 'future';
      let label = `Em ${diffDays} dias`;
      
      if (diffDays < 0) { status = 'late'; label = `Atrasado ${Math.abs(diffDays)} dias`; }
      else if (diffDays === 0) { status = 'today'; label = 'Hoje'; }

      // Cria o card
      const div = document.createElement('div');
      div.className = `review-card card-status-${status}`;
      div.innerHTML = `
        <div class="card-header">
          <span class="card-badge">${r.subject || 'Geral'}</span>
          <span>Ciclo ${r.level || 1}</span>
        </div>
        <div class="card-body">
          <h3>${r.topic}</h3>
          <p><i class="far fa-calendar-alt"></i> ${label} (${new Date(r.nextReview).toLocaleDateString()})</p>
        </div>
        <div class="card-actions">
          <button class="srs-btn btn-hard" onclick="processReview('${r.id}', 'hard')">Dif√≠cil<br><small>1 dia</small></button>
          <button class="srs-btn btn-good" onclick="processReview('${r.id}', 'good')">Bom<br><small>${getNextInterval(r.level, 'good')} dias</small></button>
          <button class="srs-btn btn-easy" onclick="processReview('${r.id}', 'easy')">F√°cil<br><small>${getNextInterval(r.level, 'easy')} dias</small></button>
        </div>
        <div class="future-text">Agendado</div>
      `;
      container.appendChild(div);
    });
  }

  // --- L√ìGICA SRS (Spaced Repetition) ---
  
  function getNextInterval(currentLevel, rating) {
    const level = currentLevel || 1;
    if (rating === 'hard') return 1;
    
    let nextLevel = level;
    if (rating === 'good') nextLevel = level + 1;
    if (rating === 'easy') nextLevel = level + 2; // Pula 1 n√≠vel
    
    // Limita ao tamanho do array
    const idx = Math.min(nextLevel - 1, INTERVALS.length - 1);
    return INTERVALS[idx];
  }

  window.processReview = async function(reviewId, rating) {
    if(!auth.currentUser) return;
    
    // Encontra o item atual
    const itemIndex = allReviews.findIndex(r => r.id === reviewId);
    if (itemIndex === -1) return;
    const item = allReviews[itemIndex];

    // Calcula novo n√≠vel e data
    let newLevel = item.level || 1;
    if (rating === 'hard') newLevel = 1; // Reseta
    else if (rating === 'good') newLevel++; // Avan√ßa
    else if (rating === 'easy') newLevel += 2; // Avan√ßa r√°pido

    // Pega os dias correspondentes ao novo n√≠vel
    const daysToAdd = INTERVALS[Math.min(newLevel - 1, INTERVALS.length - 1)];
    
    const nextDate = new Date();
    nextDate.setDate(nextDate.getDate() + daysToAdd);

    // Atualiza no Firebase
    const updates = {
      nextReview: nextDate.toISOString(),
      lastReviewed: new Date().toISOString(),
      level: newLevel
    };

    try {
      await database.ref(`users/${auth.currentUser.uid}/reviews/${reviewId}`).update(updates);
      
      // Atualiza Localmente (para n√£o precisar recarregar)
      allReviews[itemIndex].nextReview = nextDate.toISOString();
      allReviews[itemIndex].level = newLevel;
      
      updateDashboard();
      renderReviews(); // Redesenha a tela
      
    } catch (e) { console.error("Erro ao salvar revis√£o:", e); alert("Erro ao salvar."); }
  };
  
  // Fecha sidebar mobile
  document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('sidebar');
    const btn = document.querySelector('.mobile-menu-btn');
    if(window.innerWidth <= 900 && !sidebar.contains(e.target) && !btn.contains(e.target)) {
      sidebar.classList.remove('open');
      document.getElementById('sidebar-overlay').classList.remove('show');
    }
  });

</script>
</body>
</html>
