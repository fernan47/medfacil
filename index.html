<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracker de Estudos + Pomodoro</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  
  <style>
    /* --- CSS GERAL --- */
    :root {
      --primary-color: #4a6fa5;
      --secondary-color: #166088;
      --accent-color: #4fc3f7;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --break-color: #66bb6a; /* Cor para a pausa */
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --text-color: #333;
      --border-radius: 12px;
      --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --sidebar-width: 250px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; color: var(--text-color); background-color: #f5f7fa; display: flex; min-height: 100vh; }
    
    /* Sidebar */
    #sidebar { width: var(--sidebar-width); background: linear-gradient(135deg, #2c3e50, #4a6fa5); color: white; padding: 30px 20px; position: fixed; height: 100%; box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; z-index: 100; }
    #sidebar .logo { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    #sidebar .logo h2 { color: white; font-weight: 500; }
    #sidebar .logo i { font-size: 2rem; margin-bottom: 10px; color: var(--accent-color); }
    .sidebar-menu { list-style: none; }
    .sidebar-menu li { margin-bottom: 10px; }
    .sidebar-button { display: flex; align-items: center; padding: 12px 15px; border-radius: var(--border-radius); color: white; text-decoration: none; transition: all 0.3s ease; font-size: 0.95rem; }
    .sidebar-button:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateX(5px); }
    .sidebar-button i { margin-right: 10px; font-size: 1.1rem; width: 20px; text-align: center; }
    .sidebar-button.active { background-color: var(--accent-color); color: var(--dark-color); font-weight: 500; }
    
    /* Main Content */
    #main-content { flex: 1; margin-left: var(--sidebar-width); padding: 30px; max-width: 1000px; margin: 0 auto; padding-left: calc(var(--sidebar-width) + 30px); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header h1 { color: var(--primary-color); font-weight: 500; }
    
    /* Stats */
    .today-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .today-stat-card { background-color: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow); text-align: center; }
    .today-stat-card h3 { color: var(--secondary-color); font-size: 1rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .today-stat-card p { font-size: 1.8rem; font-weight: 600; color: var(--primary-color); }
    
    /* --- NOVA ÁREA DO TIMER (COM ABAS) --- */
    .timer-wrapper {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 30px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .timer-tabs {
      display: flex;
      background-color: #f1f3f5;
      border-bottom: 1px solid #ddd;
    }

    .timer-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
      color: #666;
      transition: 0.3s;
    }

    .timer-tab.active {
      background-color: white;
      color: var(--primary-color);
      border-top: 3px solid var(--primary-color);
      font-weight: bold;
    }

    .timer-section { padding: 30px; text-align: center; }
    
    #timer { 
      font-size: 4.5rem; 
      font-weight: bold; 
      color: var(--secondary-color); 
      margin: 10px 0; 
      font-family: 'Courier New', monospace; 
      letter-spacing: 2px;
      transition: color 0.3s;
    }

    /* Estilo quando está em pausa */
    .break-mode #timer { color: var(--break-color); }

    /* Configurações do Pomodoro (Inputs) */
    .pomodoro-settings {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    .pomo-input { display: flex; flex-direction: column; align-items: center; }
    .pomo-input label { font-size: 0.85rem; margin-bottom: 5px; color: #666; }
    .pomo-input input { width: 70px; padding: 8px; text-align: center; border-radius: 8px; border: 1px solid #ddd; }

    .button-container { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
    .button { padding: 12px 24px; font-size: 1rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-weight: 500; }
    .button-primary { background-color: var(--primary-color); color: white; }
    .button-primary:hover { background-color: var(--secondary-color); transform: translateY(-2px); }
    .button-danger { background-color: var(--danger-color); color: white; }
    .button-danger:hover { background-color: #d32f2f; transform: translateY(-2px); }
    .button-break { background-color: var(--break-color); color: white; } /* Botão de Pausa */
    .button-break:hover { background-color: #43a047; transform: translateY(-2px); }

    /* Search e Inputs de Exercício */
    .search-section-wrapper { margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .search-container { position: relative; width: 100%; margin: 0 auto; }
    #inputTema { width: 100%; padding: 12px 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 12px; outline: none; transition: border-color 0.3s; background: white; }
    #inputTema:focus { border-color: var(--primary-color); }
    .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
    .suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
    .suggestion-item:hover { background-color: #f9f9f9; }
    .category-tag { font-size: 11px; color: #555; background: #e0e0e0; padding: 3px 8px; border-radius: 10px; margin-left: 10px; }

    .exercises-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .input-group { display: flex; flex-direction: column; }
    label { margin-bottom: 8px; font-weight: 500; color: var(--secondary-color); }
    input[type="number"] { padding: 12px; border: 1px solid #ddd; border-radius: var(--border-radius); font-size: 1rem; transition: border 0.3s ease; width: 100%; background: white; }
    
    /* Stats Grid */
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background-color: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow); text-align: center; }
    .stat-card h3 { color: var(--secondary-color); font-size: 1rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .stat-card p { font-size: 1.8rem; font-weight: 600; color: var(--primary-color); }
    .progress-container { height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-top: 15px; overflow: hidden; }
    .progress-bar { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--accent-color), var(--primary-color)); width: 0%; transition: width 0.5s ease; }
    
    .hidden { display: none !important; }

    @media (max-width: 992px) {
      #sidebar { width: 70px; padding: 20px 10px; overflow: hidden; }
      #sidebar .logo h2, .sidebar-button span { display: none; }
      #sidebar .logo i { margin-right: 0; font-size: 1.8rem; }
      .sidebar-button { justify-content: center; padding: 12px 5px; }
      #main-content { margin-left: 70px; padding-left: 20px; }
    }
    @media (max-width: 768px) {
      .today-stats { grid-template-columns: 1fr; }
      .exercises-section { grid-template-columns: 1fr; }
      .button-container { flex-direction: column; }
      #timer { font-size: 3.5rem; }
    }
  </style>
</head>

<body>
  <div id="sidebar">
    <div class="logo"><i class="fas fa-book-open"></i><h2>Med Fácil</h2></div>
    <ul class="sidebar-menu">
      <li><a href="#" class="sidebar-button active"><i class="fas fa-home"></i><span>Início</span></a></li>
      <li><a href="historico.html" class="sidebar-button"><i class="fas fa-history"></i><span>Histórico</span></a></li>
      <li><a href="conteudos.html" class="sidebar-button"><i class="fas fa-book"></i><span>Conteúdos</span></a></li>
      <li><a id="downloadButton" href="#" class="sidebar-button hidden"><i class="fas fa-download"></i><span>Exportar Dados</span></a></li>
      <li><a id="importButton" href="#" class="sidebar-button"><i class="fas fa-upload"></i><span>Importar Dados</span></a></li>
      <li><a id="btnLogout" href="#" class="sidebar-button"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></li>
    </ul>
  </div>

  <div id="main-content">
    <div class="header"><h1>Tracker de Estudos</h1></div>
    
    <div class="today-stats">
      <div class="today-stat-card"><h3><i class="fas fa-clock"></i> Hoje estudado</h3><p id="todayStudyTime">00:00:00</p></div>
      <div class="today-stat-card"><h3><i class="fas fa-tasks"></i> Exercícios hoje</h3><p id="todayExercises">0</p></div>
    </div>

    <div class="timer-wrapper">
      <div class="timer-tabs">
        <div class="timer-tab active" onclick="switchMode('free')"><i class="fas fa-stopwatch"></i> Modo Livre</div>
        <div class="timer-tab" onclick="switchMode('pomodoro')"><i class="fas fa-hourglass-half"></i> Pomodoro</div>
      </div>

      <div class="timer-section" id="timerContainer">
        
        <div id="pomodoroSettings" class="pomodoro-settings hidden">
          <div class="pomo-input">
            <label>Foco (min)</label>
            <input type="number" id="focusTime" value="25" min="1">
          </div>
          <div class="pomo-input">
            <label>Pausa (min)</label>
            <input type="number" id="breakTime" value="5" min="1">
          </div>
        </div>

        <div id="timer">00:00:00</div>
        
        <div class="button-container">
          <div id="freeControls">
            <button id="startButton" class="button button-primary"><i class="fas fa-play"></i> Iniciar Estudo</button>
            <button id="stopButton" class="button button-danger hidden"><i class="fas fa-stop"></i> Parar e Salvar</button>
          </div>

          <div id="pomodoroControls" class="hidden">
            <button id="pomoStart" class="button button-primary"><i class="fas fa-play"></i> Iniciar Foco</button>
            <button id="pomoBreak" class="button button-break hidden"><i class="fas fa-coffee"></i> Iniciar Pausa</button>
            <button id="pomoStop" class="button button-danger hidden"><i class="fas fa-save"></i> Salvar Sessão</button>
            <button id="pomoReset" class="button hidden" style="background:#ddd; color:#333;"><i class="fas fa-redo"></i> Reset</button>
          </div>
        </div>
      </div>
    </div>

    <div class="search-section-wrapper">
      <div class="search-container">
        <label for="inputTema" style="display:block; margin-bottom:8px; font-weight:500; color:#166088;"><i class="fas fa-search"></i> O que vamos estudar?</label>
        <input type="text" id="inputTema" placeholder="Digite o tema (ex: Asma...)" autocomplete="off">
        <div id="listaSugestoes" class="suggestions-list"></div>
      </div>
    </div>

    <div class="exercises-section">
      <div class="input-group"><label for="exercisesInput"><i class="fas fa-tasks"></i> Exercícios Feitos:</label><input type="number" id="exercisesInput" value="0" min="0"></div>
      <div class="input-group"><label for="correctExercisesInput"><i class="fas fa-check-circle"></i> Exercícios Corretos:</label><input type="number" id="correctExercisesInput" value="0" min="0"></div>
    </div>

    <div class="stats-container">
      <div class="stat-card"><h3><i class="fas fa-clock"></i> Tempo Total</h3><p id="totalStudyTime">00:00:00</p></div>
      <div class="stat-card"><h3><i class="fas fa-calendar-week"></i> Esta Semana</h3><p id="weeklyStudyTime">00:00:00</p></div>
      <div class="stat-card"><h3><i class="fas fa-tasks"></i> Exercícios Feitos</h3><p id="totalExercisesDone">0</p></div>
      <div class="stat-card"><h3><i class="fas fa-check-circle"></i> Exercícios Corretos</h3><p id="totalExercisesCorrect">0</p></div>
      <div class="stat-card"><h3><i class="fas fa-bullseye"></i> Precisão Média</h3><p id="averageAccuracy">0%</p></div>
      <div class="stat-card"><h3><i class="fas fa-bullseye"></i> Meta Semanal</h3><p>20 horas</p><div class="progress-container"><div class="progress-bar" id="weeklyProgress"></div></div></div>
    </div>

    <div id="sessionList"></div>
  </div>

  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    // --- CONFIGURAÇÃO FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCWNFjeLIjBgDa5v3W5vsCdJ1PGDeHE35A",
      authDomain: "meu-study-tracker.firebaseapp.com",
      databaseURL: "https://meu-study-tracker-default-rtdb.firebaseio.com",
      projectId: "meu-study-tracker",
      storageBucket: "meu-study-tracker.firebasestorage.app",
      messagingSenderId: "715609213126",
      appId: "1:715609213126:web:3e9cbe7e840ea20a1b6fc7"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // --- DADOS DE TEMAS (Mantidos) ---
    const dadosTemas = {
      "Cirurgia Geral": ["Anestesia", "Apendicite aguda", "Choque", "Cicatrização", "Cirurgia vascular", "Cistite aguda", "Hérnias", "Pancreatite aguda", "Queimaduras", "Trauma abdominal", "Trauma torácico"],
      "Clínica Médica": ["Asma", "COVID-19", "Cefaleias", "Dengue", "Diabetes", "HAS", "HIV", "IAM", "ICC", "Pneumonia", "Sepse", "Tuberculose"],
      "Ginecologia e Obstetrícia": ["Abortamento", "Pré-natal", "Câncer de colo uterino", "Câncer de mama", "Diabetes gestacional", "DHEG", "Parto", "Vulvovaginites"],
      "Pediatria": ["Aleitamento", "Asma", "Bronquiolite", "Cardiopatias", "Desenvolvimento", "Imunização", "Pneumonias", "Puericultura"],
      "Medicina Preventiva": ["Epidemiologia", "SUS", "Ética médica", "Vigilância epidemiológica"]
    };
    const listaCompleta = [];
    for (const [cat, temas] of Object.entries(dadosTemas)) { temas.forEach(t => listaCompleta.push({ nome: t, categoria: cat })); }
    let selectedCategory = "Outros";

    // --- ESTADO DO APP ---
    let currentMode = 'free'; // 'free' ou 'pomodoro'
    let pomodoroState = 'idle'; // 'idle', 'focus', 'break'
    let startTime, timerInterval, totalTime = 0;
    let pomoTimeLeft = 0;
    let sessionsByDate = {};
    let dbRef;

    // Elementos DOM
    const timerDisplay = document.getElementById('timer');
    const alarmSound = document.getElementById('alarmSound');
    const container = document.getElementById('timerContainer');
    
    // --- LÓGICA DE BUSCA ---
    const inputTema = document.getElementById('inputTema');
    const listaSugestoes = document.getElementById('listaSugestoes');
    inputTema.addEventListener('input', function() {
      const txt = this.value.toLowerCase();
      listaSugestoes.innerHTML = ''; 
      if (!txt) { listaSugestoes.style.display = 'none'; return; }
      const res = listaCompleta.filter(i => i.nome.toLowerCase().includes(txt));
      if (res.length > 0) {
        listaSugestoes.style.display = 'block';
        res.slice(0, 10).forEach(item => {
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.innerHTML = `<span>${item.nome}</span><span class="category-tag">${item.categoria}</span>`;
          div.addEventListener('click', () => {
            inputTema.value = item.nome; 
            selectedCategory = item.categoria;
            listaSugestoes.style.display = 'none'; 
          });
          listaSugestoes.appendChild(div);
        });
      } else { listaSugestoes.style.display = 'none'; }
    });
    document.addEventListener('click', e => { if(e.target!==inputTema) listaSugestoes.style.display='none'; });

    // --- LÓGICA DO CRONÔMETRO (MODO LIVRE) ---
    function startFree() {
      startTime = new Date().getTime();
      timerInterval = setInterval(() => {
        const now = new Date().getTime();
        totalTime = now - startTime;
        timerDisplay.textContent = formatTime(totalTime);
      }, 1000);
      document.getElementById('startButton').classList.add('hidden');
      document.getElementById('stopButton').classList.remove('hidden');
    }

    // --- LÓGICA DO POMODORO ---
    function startPomodoroFocus() {
      const mins = parseInt(document.getElementById('focusTime').value);
      pomoTimeLeft = mins * 60;
      pomodoroState = 'focus';
      updatePomoDisplay();
      
      // Esconde controles
      document.getElementById('pomoStart').classList.add('hidden');
      document.getElementById('pomoStop').classList.remove('hidden');
      document.getElementById('pomodoroSettings').classList.add('hidden'); // Trava inputs
      container.classList.remove('break-mode');

      timerInterval = setInterval(() => {
        pomoTimeLeft--;
        updatePomoDisplay();
        if (pomoTimeLeft <= 0) {
          // Fim do Foco
          clearInterval(timerInterval);
          alarmSound.play();
          alert("Fim do Foco! Hora de salvar ou descansar.");
          
          // O tempo de estudo a ser salvo é o tempo configurado
          totalTime = mins * 60 * 1000; 
          
          // Prepara UI para o Break
          document.getElementById('pomoStop').classList.remove('hidden'); // Usuário deve salvar agora
          document.getElementById('pomoBreak').classList.remove('hidden');
        }
      }, 1000);
    }

    function startPomodoroBreak() {
      const mins = parseInt(document.getElementById('breakTime').value);
      pomoTimeLeft = mins * 60;
      pomodoroState = 'break';
      updatePomoDisplay();
      
      container.classList.add('break-mode'); // Muda cor do texto
      document.getElementById('pomoBreak').classList.add('hidden');
      document.getElementById('pomoStop').classList.add('hidden'); // Não pode salvar pausa

      timerInterval = setInterval(() => {
        pomoTimeLeft--;
        updatePomoDisplay();
        if (pomoTimeLeft <= 0) {
          clearInterval(timerInterval);
          alarmSound.play();
          alert("Fim da Pausa! Volte a estudar.");
          resetPomodoroUI();
        }
      }, 1000);
    }

    function updatePomoDisplay() {
      const m = Math.floor(pomoTimeLeft / 60);
      const s = pomoTimeLeft % 60;
      timerDisplay.textContent = `${pad(m)}:${pad(s)}`;
    }

    function resetPomodoroUI() {
      clearInterval(timerInterval);
      pomodoroState = 'idle';
      container.classList.remove('break-mode');
      timerDisplay.textContent = "00:00";
      document.getElementById('pomoStart').classList.remove('hidden');
      document.getElementById('pomoStop').classList.add('hidden');
      document.getElementById('pomoBreak').classList.add('hidden');
      document.getElementById('pomodoroSettings').classList.remove('hidden');
    }

    // --- ALTERNAR MODOS ---
    window.switchMode = function(mode) {
      clearInterval(timerInterval);
      currentMode = mode;
      
      // UI Tabs
      document.querySelectorAll('.timer-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // Toggle Sections
      if (mode === 'free') {
        document.getElementById('freeControls').classList.remove('hidden');
        document.getElementById('pomodoroControls').classList.add('hidden');
        document.getElementById('pomodoroSettings').classList.add('hidden');
        document.getElementById('timer').textContent = "00:00:00";
        totalTime = 0;
        document.getElementById('startButton').classList.remove('hidden');
        document.getElementById('stopButton').classList.add('hidden');
      } else {
        document.getElementById('freeControls').classList.add('hidden');
        document.getElementById('pomodoroControls').classList.remove('hidden');
        document.getElementById('pomodoroSettings').classList.remove('hidden');
        document.getElementById('timer').textContent = "00:00";
        resetPomodoroUI();
      }
    };

    // --- SALVAR SESSÃO (Universal) ---
    function saveSession() {
      clearInterval(timerInterval);
      
      // Se for Modo Livre, usa o totalTime acumulado.
      // Se for Pomodoro, totalTime foi setado no fim do foco.
      const sessionTimeStr = currentMode === 'free' ? formatTime(totalTime) : formatPomoTime(totalTime);
      
      const exInput = document.getElementById('exercisesInput');
      const corInput = document.getElementById('correctExercisesInput');
      const exDone = parseInt(exInput.value);
      const exCorrect = parseInt(corInput.value);
      
      const now = new Date();
      const dateKey = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
      
      if (!sessionsByDate[dateKey]) sessionsByDate[dateKey] = [];
      
      const accuracy = exDone > 0 ? (exCorrect/exDone*100).toFixed(2) : '0.00';
      const sessionData = {
        time: sessionTimeStr,
        exercisesDone: exDone,
        exercisesCorrect: exCorrect,
        accuracy: accuracy,
        subject: selectedCategory,
        topic: inputTema.value || "Geral"
      };

      sessionsByDate[dateKey].push(sessionData);

      dbRef.set(sessionsByDate).then(() => {
        console.log("Salvo!");
        inicializarDashboard();
      }).catch(e => {
        if(e.code==='PERMISSION_DENIED') alert("Sua conta precisa ser ativada!");
        else alert("Erro ao salvar.");
        sessionsByDate[dateKey].pop();
      });

      // Reset
      totalTime = 0;
      exInput.value = 0; corInput.value = 0; inputTema.value = ''; selectedCategory = "Outros";
      if (currentMode === 'free') {
        document.getElementById('startButton').classList.remove('hidden');
        document.getElementById('stopButton').classList.add('hidden');
        timerDisplay.textContent = "00:00:00";
      } else {
        resetPomodoroUI();
      }
    }

    // --- FORMATADORES ---
    function pad(n) { return n.toString().padStart(2, '0'); }
    function formatTime(ms) {
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      const s = Math.floor((ms%60000)/1000);
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }
    function formatPomoTime(ms) {
      // Pomodoro salva como 00:25:00 por exemplo
      return formatTime(ms); 
    }

    // --- AUTH & LOAD ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        dbRef = database.ref('users/' + user.uid + '/sessionsByDate');
        
        // Listeners dos Botões
        document.getElementById('startButton').addEventListener('click', startFree);
        document.getElementById('stopButton').addEventListener('click', saveSession);
        
        document.getElementById('pomoStart').addEventListener('click', startPomodoroFocus);
        document.getElementById('pomoBreak').addEventListener('click', startPomodoroBreak);
        document.getElementById('pomoStop').addEventListener('click', saveSession);
        document.getElementById('pomoReset').addEventListener('click', resetPomodoroUI);

        document.getElementById('btnLogout').addEventListener('click', (e)=>{e.preventDefault(); auth.signOut().then(()=>window.location.href='login.html');});

        // Carregar dados
        try {
          const snap = await dbRef.get();
          if (snap.exists()) sessionsByDate = snap.val();
          inicializarDashboard();
        } catch (e) { console.error(e); }
      } else {
        window.location.href = 'login.html';
      }
    });

    // Funções de Dashboard (Resumidas para caber, copie as do seu index anterior se precisar da lógica completa de estatísticas)
    function inicializarDashboard() {
      // Aqui vai sua lógica de atualizar os cards "Hoje estudado", "Meta", etc.
      // Vou incluir a básica de "Hoje" para feedback imediato.
      const now = new Date();
      const key = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
      let msToday = 0; let exToday = 0;
      if(sessionsByDate[key]) {
        sessionsByDate[key].forEach(s => {
          const p = s.time.split(':').map(Number);
          msToday += (p[0]*3600000 + p[1]*60000 + p[2]*1000);
          exToday += s.exercisesDone;
        });
      }
      document.getElementById('todayStudyTime').textContent = formatTime(msToday);
      document.getElementById('todayExercises').textContent = exToday;
    }

  </script>
</body>
</html>
